<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Statistiche Orari Profumeria</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --border:#e6e8f0; --muted:#6b7280; --ink:#0f172a;
      --head:#0b1220; --accent:#16a34a; --danger:#dc2626; --balanced-bg:#ebfbee; --balanced-br:#86efac;
      --focus-br:#374151; --focus-bg:#f7f7fa;
    }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--ink) }
    header{ position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid var(--border) }
    .wrap{ max-width: 1680px; margin:0 auto; padding:18px 20px; }

    /* HEADER centrato */
    header .wrap{ display:flex; flex-direction:column; align-items:center; text-align:center; }
    h1{ margin:0; font-size:22px; color:var(--head); }
    .badges{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; justify-content:center; }
    .badge{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--border); background:var(--card); border-radius:999px; font-size:12px }
    .range{ margin-top:6px; color:var(--muted); font-size:12px; }

    main.wrap{ display:flex; flex-direction:column; gap:18px }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 1px 6px rgba(0,0,0,.04) }
    .card-header{ padding:14px 16px; border-bottom:1px solid var(--border) }
    .card-title{ margin:0; font-size:16px; color:var(--head) }
    .card-body{ padding:12px 16px }

    .table-wrap{ border:1px solid var(--border); border-radius:12px; overflow:auto; max-height:70vh; background:#fff }
    table{ width:100%; border-collapse:separate; border-spacing:0; font-size:15px; min-width: 980px; }
    thead th{ position:sticky; top:0; background:#fff; z-index:2; color:#0b1220; border-bottom:1px solid var(--border); font-weight:700; padding:12px 10px; white-space:nowrap }
    tbody td{ padding:12px 10px; border-bottom:1px solid var(--border); background:#fff }
    tbody tr:nth-child(even) td{ background:#fafafa }
    tbody tr:hover td{ background:#f1f5f9 }
    th:first-child, td:first-child{ text-align:left; width:180px }
    /* prima colonna sticky */
    th:first-child{ position: sticky; left: 0; z-index: 3; }
    td:first-child{ position: sticky; left: 0; z-index: 1; background:#fff; }

    .num{ text-align:center; font-variant-numeric:tabular-nums; white-space:nowrap }
    .weeks{ text-align:left; white-space:normal; max-width:320px }

    .ring{ display:inline-flex; align-items:center; justify-content:center; min-width:2.4ch; padding:2px 6px; line-height:1.2; border:2px solid transparent; border-radius:9999px; background:transparent }
    .ring.red{ border-color:var(--danger) }

    .balanced-col{ background:var(--balanced-bg)!important }
    th.balanced-col{ border-bottom-color:var(--balanced-br) }
    .balanced-outline{ box-shadow: inset 2px 0 0 var(--balanced-br), inset -2px 0 0 var(--balanced-br) }

    .focus { background: var(--focus-bg); }
    .focus-start { border-left: 2px solid var(--focus-br); }
    .focus-end { border-right: 2px solid var(--focus-br); }

    .legend{ font-size:14px; color:#111 }
    .legend h3{ margin:0 0 10px; font-size:15px; color:var(--head) }
    .legend ul{ margin:6px 0 12px 18px; padding:0 }
    .legend li{ margin:6px 0 }
    .legend .muted{ color:var(--muted); font-size:12px }

    .notes table{ width:100%; border-collapse:separate; border-spacing:0; font-size:15px; min-width: 680px; }
    .notes th,.notes td{ padding:10px 8px; border-bottom:1px solid var(--border) }
    .notes thead th{ background:#fff; position:sticky; top:0; z-index:1 }

    /* PLANNER */
    .planner table{ width:100%; border-collapse:separate; border-spacing:0; font-size:15px; min-width: 980px; }
    .planner th,.planner td{ padding:10px 8px; border-bottom:1px solid var(--border); }
    .planner thead th{ position:sticky; top:0; z-index:2; background:#fff }
    .planner select{ width:100%; padding:6px 8px; border:1px solid var(--border); border-radius:8px; background:#fff; font-size:14px }
    .planner tfoot td{ background:#fafafa }

    .pill{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; background:#fff }
    .pill.ok{ border-color:#16a34a }
    .pill.warn{ border-color:#d97706 }
    .pill.bad{ border-color:#dc2626 }
    .muted{ color:var(--muted) }

    .home-chooser{ display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 6px }
    .home-chooser label{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#fff; font-size:12px; cursor:pointer }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>üìä Statistiche Orari Profumeria</h1>
      <div class="badges">
        <div class="badge" id="isoBadge">Settimana ISO: ‚Ä¶</div>
        <div class="badge" id="updBadge">Aggiornato: ‚Ä¶</div>
      </div>
      <div id="rangeInfo" class="range">Dati elaborati dal ‚Äî al ‚Äî</div>
    </div>
  </header>

  <main class="wrap" aria-live="polite">
    <section class="card" aria-label="Riepilogo per dipendente">
      <div class="card-header"><h2 class="card-title">Riepilogo per dipendente</h2></div>
      <div class="card-body">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Dipendente</th>
                <th id="th-ap">Aperture</th>
                <th id="th-ch">Chiusure</th>
                <th id="th-apwe">Aperture WE/Festivi</th>
                <th id="th-chwe">Chiusure WE/Festivi</th>
                <th id="th-fe">Ferie</th>
                <th id="th-ri">Riposo</th>
                <th id="th-104">104</th>
                <th id="th-ma">Malattia</th>
                <th id="th-evn" class="focus focus-start">N¬∞ WE Lunghi</th>
                <th id="th-evp" class="focus">%  WE Lunghi</th>
                <th id="th-evw" class="focus focus-end">Settimane (ISO) eventi</th>
              </tr>
            </thead>
            <tbody id="riepilogo"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="card" id="legend">
      <div class="card-header"><h2 class="card-title">Legenda & criteri di calcolo</h2></div>
      <div class="card-body legend">
        <h3>Weekend Lunghi</h3>
        <ul>
          <li>
            <div class="muted">Seleziona quali eventi contano come <b>‚Äúa casa‚Äù</b> (storico + simulazione):</div>
            <div class="home-chooser" id="homeChooser"></div>
            <div class="muted">Per i weekend lunghi, <b>FESTIVO</b> √® letto direttamente dal foglio/planner (cella ‚ÄúFESTIVO‚Äù sul dipendente), non dal calendario.</div>
            <div class="muted">Default consigliato: <code>FERIE</code>, <code>RIPOSO</code>, <code>104</code>, <code>MALATTIA</code>.</div>
          </li>
          <li><b>Settimana ISO</b>: luned√¨‚Äìdomenica (la settimana 01 √® quella che contiene il 4 gennaio).</li>
          <li><b>Scatta un evento (ancorato alla domenica) se si verifica almeno uno tra:</b>
            <ul>
              <li>A) <b>Venerd√¨ + Sabato + Domenica</b> tutti e tre ‚Äúa casa‚Äù.</li>
              <li>B) <b>Sabato + Domenica + Luned√¨</b> tutti e tre ‚Äúa casa‚Äù.</li>
              <li>C) <b>Sabato + Domenica</b> entrambi ‚Äúa casa‚Äù.</li>
              <li>D) <b>Domenica + Luned√¨</b> entrambi ‚Äúa casa‚Äù.</li>
              <li>E) <b>Domenica</b> ‚Äúa casa‚Äù + <b>luned√¨ successivo festivo</b>.</li>
              <li>F) <b>Venerd√¨ festivo</b> + <b>Sabato</b> ‚Äúa casa‚Äù + <b>Domenica</b> ‚Äúa casa‚Äù.</li>
              <li>G) <b>Sabato + Domenica</b> entrambi ‚Äúa casa‚Äù + <b>luned√¨ successivo festivo</b>.</li>
            </ul>
          </li>
        </ul>

        <!-- ‚¨áÔ∏è NUOVO: scelta delle regole attive (persistente) -->
        <div style="margin-top:12px">
          <div class="muted">Attiva/disattiva le condizioni che fanno scattare l‚Äô<b>evento ancorato alla domenica</b>:</div>
          <div id="rulesChooser" class="home-chooser" style="margin-top:6px"></div>
        </div>

        <h3 style="margin-top:16px">Bollini e bilanciamento</h3>
        <ul>
          <li><span class="ring red">52</span> = <b>outlier</b> (valore pi√π distante dalla quota equa). Un solo bollino per colonna.</li>
          <li><b>Colonna verde</b> = differenze irrilevanti: <code>max(quota) ‚àí min(quota) ‚â§ 5pp</code>, quota = <code>val/somma</code>.</li>
        </ul>
      </div>
    </section>

    <section class="card notes" aria-label="Note per Orari della prossima settimana">
      <div class="card-header"><h2 class="card-title">Note per Orari della prossima settimana</h2></div>
      <div class="card-body">
        <div class="table-wrap" style="max-height:50vh;">
          <table>
            <thead><tr><th>Voce</th><th>Consiglio</th></tr></thead>
            <tbody id="notesBody"></tbody>
          </table>
        </div>
        <div class="range" style="margin-top:8px;">
          Le note confrontano tutti i dipendenti con l‚Äô<b>outlier</b> della colonna (alto o basso) e suggeriscono ‚Äú<b>aumentare a</b>‚Äù / ‚Äú<b>diminuire a</b>‚Äù.
        </div>
      </div>
    </section>

    <section class="card planner" aria-label="Pianifica orari settimana prossima">
      <div class="card-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap">
        <h2 class="card-title">Pianifica orari ‚Äì settimana prossima</h2>
        <div class="badges" style="margin:0">
          <div class="badge" id="plannerRange">Settimana: ‚Äî</div>
          <label class="badge" style="cursor:pointer"><input id="chkCumulative" type="checkbox" checked /> Valuta sul cumulato</label>
          <button id="btnEval" class="badge" style="cursor:pointer">Valuta pianificazione</button>
          <button id="btnReset" class="badge" style="cursor:pointer">Reset</button>
          <!-- NUOVO: pulsante di salvataggio -->
          <button id="btnSave" class="badge" style="cursor:pointer">Convalida & scrivi</button>
        </div>
      </div>
      <div class="card-body">
        <div class="table-wrap" style="max-height:none">
          <table>
            <thead id="plannerHead"></thead>
            <tbody id="plannerBody"></tbody>
          </table>
        </div>
        <div style="margin-top:10px; display:flex; gap:16px; align-items:center; flex-wrap:wrap">
          <div class="pill" id="plannerStatus">Pronto alla valutazione</div>
          <div class="muted">Nella simulazione contano gli eventi selezionati come ‚Äúa casa‚Äù nella legenda.</div>
        </div>
      </div>
    </section>

    <section class="card" aria-label="Valutazione congruit√† pianificazione">
      <div class="card-header"><h2 class="card-title">Valutazione congruit√† rispetto alle note</h2></div>
      <div class="card-body">
        <div class="table-wrap" style="max-height:50vh;">
          <table>
            <thead><tr><th>Voce</th><th>Esito</th><th>Dettaglio</th></tr></thead>
            <tbody id="planFeedback"></tbody>
          </table>
        </div>
        <div class="range" id="planSummary" style="margin-top:8px;">‚Äî</div>
      </div>
    </section>
  </main>

  <script>
    // === CONFIG: link Google Sheet pubblicato (LETTURA) ===
    const PUBHTML = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTH7VUajc9qeQfzNkrOYNykZUALgfqN6nYzE3hNdQEO0uOk__412V2kkjAlxPeUKxftldk3qXyfCDg5/pubhtml?gid=0&single=true";

    // === CONFIG: Web App GAS (SCRITTURA) ===
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwR9Lc0ogxIB4waTSawg16u2EeMZnM5lI6-EOfgekzGcBvIw1Mu0432P9xXjB5nor_P/exec"; // <-- CAMBIA se serve
    const SAVE_TOKEN = 'ProfumeriaLoreto';  // <-- CAMBIA (stesso valore anche nel GAS)

    // === UTILS ===
    function getPubInfo(pubhtml){
      const idm = pubhtml.match(/\/d\/e\/([^\/]+)\/pubhtml/);
      if(!idm) throw new Error("PUB_ID non riconosciuto nel link.");
      const gidm = pubhtml.match(/[?&]gid=(\d+)/);
      return { pubId: idm[1], gid: gidm ? gidm[1] : "0" };
    }
    async function fetchCSV(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error(`Fetch failed ${r.status}`);
      const text = await r.text();
      const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
      if (parsed.errors.length) console.warn("PapaParse errors:", parsed.errors);
      return parsed.data;
    }
    function parseItaDate(dstr){
      if (!dstr) return null;
      const ymd = dstr.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (ymd) return new Date(+ymd[1], +ymd[2]-1, +ymd[3]);
      const dmy = dstr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (dmy) return new Date(+dmy[3], +dmy[2]-1, +dmy[1]);
      return new Date(dstr);
    }
    function toYMD(d){
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }
    function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
    function startOfISOWeek(date){
      const d = new Date(date);
      const day = d.getDay(); // 0=dom ... 6=sab
      const diff = (day === 0 ? -6 : 1) - day; // porta a luned√¨
      const res = new Date(d);
      res.setDate(d.getDate() + diff);
      return new Date(res.getFullYear(), res.getMonth(), res.getDate());
    }
    function isoWeek(date){
      const d = new Date(Date.UTC(date.get
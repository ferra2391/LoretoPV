<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Statistiche Orari Profumeria</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --border:#e6e8f0; --muted:#6b7280; --ink:#0f172a;
      --head:#0b1220; --accent:#16a34a; --danger:#dc2626; --balanced-bg:#ebfbee; --balanced-br:#86efac;
      --focus-br:#374151; --focus-bg:#f7f7fa;
    }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--ink) }
    header{ position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid var(--border) }
    .wrap{ max-width: 1680px; margin:0 auto; padding:18px 20px; }

    header .wrap{ display:flex; flex-direction:column; align-items:center; text-align:center; }
    h1{ margin:0; font-size:22px; color:var(--head); }
    .badges{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; justify-content:center; }
    .badge{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--border); background:var(--card); border-radius:999px; font-size:12px }
    .range{ margin-top:6px; color:var(--muted); font-size:12px; }

    main.wrap{ display:flex; flex-direction:column; gap:18px }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 1px 6px rgba(0,0,0,.04) }
    .card-header{ padding:14px 16px; border-bottom:1px solid var(--border) }
    .card-title{ margin:0; font-size:16px; color:var(--head) }
    .card-body{ padding:12px 16px }

    .table-wrap{ border:1px solid var(--border); border-radius:12px; overflow:auto; max-height:70vh; background:#fff }
    table{ width:100%; border-collapse:separate; border-spacing:0; font-size:15px; min-width: 980px; }
    thead th{ position:sticky; top:0; background:#fff; z-index:2; color:#0b1220; border-bottom:1px solid var(--border); font-weight:700; padding:12px 10px; white-space:nowrap }
    tbody td{ padding:12px 10px; border-bottom:1px solid var(--border); background:#fff }
    tbody tr:nth-child(even) td{ background:#fafafa }
    tbody tr:hover td{ background:#f1f5f9 }
    th:first-child, td:first-child{ text-align:left; width:180px }
    th:first-child{ position: sticky; left: 0; z-index: 3; }
    td:first-child{ position: sticky; left: 0; z-index: 1; background:#fff; }

    .num{ text-align:center; font-variant-numeric:tabular-nums; white-space:nowrap }
    .weeks{ text-align:left; white-space:normal; max-width:320px }

    .ring{ display:inline-flex; align-items:center; justify-content:center; min-width:2.4ch; padding:2px 6px; line-height:1.2; border:2px solid transparent; border-radius:9999px; background:transparent }
    .ring.red{ border-color:var(--danger) }

    .balanced-col{ background:var(--balanced-bg)!important }
    th.balanced-col{ border-bottom-color:var(--balanced-br) }
    .balanced-outline{ box-shadow: inset 2px 0 0 var(--balanced-br), inset -2px 0 0 var(--balanced-br) }

    .focus { background: var(--focus-bg); }
    .focus-start { border-left: 2px solid var(--focus-br); }
    .focus-end { border-right: 2px solid var(--focus-br); }

    .legend{ font-size:14px; color:#111 }
    .legend h3{ margin:0 0 10px; font-size:15px; color:var(--head) }
    .legend ul{ margin:6px 0 12px 18px; padding:0 }
    .legend li{ margin:6px 0 }
    .legend .muted{ color:var(--muted); font-size:12px }

    .notes table{ width:100%; border-collapse:separate; border-spacing:0; font-size:15px; min-width: 680px; }
    .notes th,.notes td{ padding:10px 8px; border-bottom:1px solid var(--border) }
    .notes thead th{ background:#fff; position:sticky; top:0; z-index:1 }

    /* PLANNER */
    .planner table{ width:100%; border-collapse:separate; border-spacing:0; font-size:15px; min-width: 980px; }
    .planner th,.planner td{ padding:10px 8px; border-bottom:1px solid var(--border); }
    .planner thead th{ position:sticky; top:0; z-index:2; background:#fff }
    .planner select{ width:100%; padding:6px 8px; border:1px solid var(--border); border-radius:8px; background:#fff; font-size:14px }
    .planner tfoot td{ background:#fafafa }

    .pill{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; background:#fff }
    .pill.ok{ border-color:#16a34a }
    .pill.warn{ border-color:#d97706 }
    .pill.bad{ border-color:#dc2626 }
    .muted{ color:var(--muted) }

    .home-chooser{ display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 6px }
    .home-chooser label{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#fff; font-size:12px; cursor:pointer }

    /* Checkbox dentro alle frasi delle regole */
    .rules-list{ list-style:none; margin:6px 0 0 0; padding-left:0 }
    .rules-list li{ display:flex; align-items:flex-start; gap:8px; margin:6px 0 }
    .rules-list input[type="checkbox"]{ margin-top:2px }
    .rules-list b{ white-space:nowrap }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>üìä Statistiche Orari Profumeria</h1>
      <div class="badges">
        <div class="badge" id="isoBadge">Settimana ISO: ‚Ä¶</div>
        <div class="badge" id="updBadge">Aggiornato: ‚Ä¶</div>
      </div>
      <div id="rangeInfo" class="range">Dati elaborati dal ‚Äî al ‚Äî</div>
    </div>
  </header>

  <main class="wrap" aria-live="polite">
    <section class="card" aria-label="Riepilogo per dipendente">
      <div class="card-header"><h2 class="card-title">Riepilogo per dipendente</h2></div>
      <div class="card-body">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Dipendente</th>
                <th id="th-ap">Aperture</th>
                <th id="th-ch">Chiusure</th>
                <th id="th-apwe">Aperture WE/Festivi</th>
                <th id="th-chwe">Chiusure WE/Festivi</th>
                <th id="th-fe">Ferie</th>
                <th id="th-ri">Riposo</th>
                <th id="th-104">104</th>
                <th id="th-ma">Malattia</th>
                <th id="th-evn" class="focus focus-start">N¬∞ WE Lunghi</th>
                <th id="th-evp" class="focus">%  WE Lunghi</th>
                <th id="th-evw" class="focus focus-end">Settimane (ISO) eventi</th>
              </tr>
            </thead>
            <tbody id="riepilogo"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="card" id="legend">
      <div class="card-header"><h2 class="card-title">Legenda & criteri di calcolo</h2></div>
      <div class="card-body legend">
        <h3>Weekend Lunghi</h3>
        <ul>
          <li>
            <div class="muted">Seleziona quali eventi contano come <b>‚Äúa casa‚Äù</b> (storico + simulazione):</div>
            <div class="home-chooser" id="homeChooser"></div>
            <div class="muted">Per i weekend lunghi, <b>FESTIVO</b> √® letto direttamente dal foglio/planner (cella ‚ÄúFESTIVO‚Äù sul dipendente), non dal calendario.</div>
            <div class="muted">Default consigliato: <code>FERIE</code>, <code>RIPOSO</code>, <code>104</code>, <code>MALATTIA</code>.</div>
          </li>
          <li><b>Settimana ISO</b>: luned√¨‚Äìdomenica (la settimana 01 √® quella che contiene il 4 gennaio).</li>
          <li><b>Scatta un evento (ancorato alla domenica) se si verifica almeno uno tra:</b>
            <!-- verr√† popolato in JS con checkbox a sinistra -->
            <ul id="rulesList" class="rules-list"></ul>
          </li>
        </ul>

        <h3 style="margin-top:16px">Bollini e bilanciamento</h3>
        <ul>
          <li><span class="ring red">52</span> = <b>outlier</b> (valore pi√π distante dalla quota equa). Un solo bollino per colonna.</li>
          <li><b>Colonna verde</b> = differenze irrilevanti: <code>max(quota) ‚àí min(quota) ‚â§ 5pp</code>, quota = <code>val/somma</code>.</li>
        </ul>
      </div>
    </section>

    <section class="card notes" aria-label="Note per Orari della prossima settimana">
      <div class="card-header"><h2 class="card-title">Note per Orari della prossima settimana</h2></div>
      <div class="card-body">
        <div class="table-wrap" style="max-height:50vh;">
          <table>
            <thead><tr><th>Voce</th><th>Consiglio</th></tr></thead>
            <tbody id="notesBody"></tbody>
          </table>
        </div>
        <div class="range" style="margin-top:8px;">
          Le note confrontano tutti i dipendenti con l‚Äô<b>outlier</b> della colonna (alto o basso) e suggeriscono ‚Äú<b>aumentare a</b>‚Äù / ‚Äú<b>diminuire a</b>‚Äù.
        </div>
      </div>
    </section>

    <section class="card planner" aria-label="Pianifica orari settimana prossima">
      <div class="card-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap">
        <h2 class="card-title">Pianifica orari ‚Äì settimana prossima</h2>
        <div class="badges" style="margin:0">
          <div class="badge" id="plannerRange">Settimana: ‚Äî</div>
          <label class="badge" style="cursor:pointer"><input id="chkCumulative" type="checkbox" checked /> Valuta sul cumulato</label>
          <button id="btnEval" class="badge" style="cursor:pointer">Valuta pianificazione</button>
          <button id="btnReset" class="badge" style="cursor:pointer">Reset</button>
          <button id="btnSave" class="badge" style="cursor:pointer">Convalida & scrivi</button>
        </div>
      </div>
      <div class="card-body">
        <div class="table-wrap" style="max-height:none">
          <table>
            <thead id="plannerHead"></thead>
            <tbody id="plannerBody"></tbody>
          </table>
        </div>
        <div style="margin-top:10px; display:flex; gap:16px; align-items:center; flex-wrap:wrap">
          <div class="pill" id="plannerStatus">Pronto alla valutazione</div>
          <div class="muted">Nella simulazione contano gli eventi selezionati come ‚Äúa casa‚Äù nella legenda.</div>
        </div>
      </div>
    </section>

    <section class="card" aria-label="Valutazione congruit√† pianificazione">
      <div class="card-header"><h2 class="card-title">Valutazione congruit√† rispetto alle note</h2></div>
      <div class="card-body">
        <div class="table-wrap" style="max-height:50vh;">
          <table>
            <thead><tr><th>Voce</th><th>Esito</th><th>Dettaglio</th></tr></thead>
            <tbody id="planFeedback"></tbody>
          </table>
        </div>
        <div class="range" id="planSummary" style="margin-top:8px;">‚Äî</div>
      </div>
    </section>
  </main>

  <script>
    // === CONFIG LETTURA ===
    const PUBHTML = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTH7VUajc9qeQfzNkrOYNykZUALgfqN6nYzE3hNdQEO0uOk__412V2kkjAlxPeUKxftldk3qXyfCDg5/pubhtml?gid=0&single=true";
    // === CONFIG SCRITTURA ===
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwR9Lc0ogxIB4waTSawg16u2EeMZnM5lI6-EOfgekzGcBvIw1Mu0432P9xXjB5nor_P/exec";
    const SAVE_TOKEN = 'ProfumeriaLoreto';

    // === UTILS ===
    function getPubInfo(pubhtml){
      const idm = pubhtml.match(/\/d\/e\/([^\/]+)\/pubhtml/);
      if(!idm) throw new Error("PUB_ID non riconosciuto nel link.");
      const gidm = pubhtml.match(/[?&]gid=(\d+)/);
      return { pubId: idm[1], gid: gidm ? gidm[1] : "0" };
    }
    async function fetchCSV(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error(`Fetch failed ${r.status}`);
      const text = await r.text();
      const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
      if (parsed.errors.length) console.warn("PapaParse errors:", parsed.errors);
      return parsed.data;
    }
    function parseItaDate(dstr){
      if (!dstr) return null;
      const ymd = dstr.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (ymd) return new Date(+ymd[1], +ymd[2]-1, +ymd[3]);
      const dmy = dstr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (dmy) return new Date(+dmy[3], +dmy[2]-1, +dmy[1]);
      return new Date(dstr);
    }
    function toYMD(d){
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }
    function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
    function startOfISOWeek(date){
      const d = new Date(date);
      const day = d.getDay(); // 0=dom ... 6=sab
      const diff = (day === 0 ? -6 : 1) - day; // porta a luned√¨
      const res = new Date(d);
      res.setDate(d.getDate() + diff);
      return new Date(res.getFullYear(), res.getMonth(), res.getDate());
    }
    function isoWeek(date){
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const day = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - day);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }
    function isoWeekYear(date){
      const d = new Date(date.getTime());
      d.setDate(d.getDate() + 4 - (d.getDay() || 7));
      return d.getFullYear();
    }

    // === APP ===
    (async function main(){
      const now = new Date();
      document.getElementById("isoBadge").textContent = `Settimana ISO: ${isoWeek(now)}/${isoWeekYear(now)}`;
      document.getElementById("updBadge").textContent = `Aggiornato: ${now.toLocaleDateString('it-IT')} ${now.toLocaleTimeString('it-IT')}`;

      // Carico CSV
      const { pubId, gid } = getPubInfo(PUBHTML);
      let csvUrl = `https://docs.google.com/spreadsheets/d/e/${pubId}/pub?gid=${gid}&single=true&output=csv`;
      let rows;
      try { rows = await fetchCSV(csvUrl); }
      catch(e1){ csvUrl = `https://docs.google.com/spreadsheets/d/e/${pubId}/gviz/tq?gid=${gid}&tqx=out:csv`; rows = await fetchCSV(csvUrl); }

      // Colonne
      const headerKeys = rows.length ? Object.keys(rows[0]) : [];
      const colData = headerKeys.find(k => k.toLowerCase().includes("data"));
      if (!colData) throw new Error("Colonna 'Data' non trovata.");
      const dipCols = headerKeys.filter(k => /ilenia|cinzia|michela|vivien/i.test(k));
      const dipendenti = dipCols.slice();

      // Indici
      const byDate = new Map();
      let minDate = null, maxDate = null;

      // Stat storico
      const stats = {};
      dipendenti.forEach(d => stats[d] = {
        aperture:0, chiusure:0,
        apertureWEFest:0, chiusureWEFest:0,
        ferie:0, riposo:0, "104":0, malattia:0,
        eventsWeeksAll: new Set()
      });

      // Parse righe
      for (const row of rows){
        const dt = parseItaDate(row[colData]);
        if (!dt || isNaN(+dt)) continue;
        if (!minDate || dt < minDate) minDate = dt;
        if (!maxDate || dt > maxDate) maxDate = dt;

        const ymd = toYMD(dt);
        const dow = dt.getDay();
        const weekend = (dow===0 || dow===6);
        if (!byDate.has(ymd)) byDate.set(ymd, {});
        const dayObj = byDate.get(ymd);

        for (const col of dipCols){
          const raw = (row[col] || "").toString().trim().toLowerCase();
          dayObj[col] = raw;
          const festivoFromSheet = (raw === 'festivo');

          if (!raw) continue;
          if (raw === "apertura") {
            stats[col].aperture++; if (weekend || festivoFromSheet) stats[col].apertureWEFest++;
          } else if (raw === "chiusura") {
            stats[col].chiusure++; if (weekend || festivoFromSheet) stats[col].chiusureWEFest++;
          } else if (raw === "ferie") {
            stats[col].ferie++;
          } else if (raw === "riposo") {
            stats[col].riposo++;
          } else if (raw === "104") {
            stats[col]["104"]++;
          } else if (raw === "malattia") {
            stats[col].malattia++;
          }
        }
      }

      // Range
      const rangeEl = document.getElementById('rangeInfo');
      if (minDate && maxDate){
        rangeEl.textContent = `Dati elaborati dal ${minDate.toLocaleDateString('it-IT',{timeZone:'Europe/Rome'})} al ${maxDate.toLocaleDateString('it-IT',{timeZone:'Europe/Rome'})}`;
      } else {
        rangeEl.textContent = `Dati elaborati: nessuna data valida trovata nel foglio`;
      }

      const allDates = Array.from(byDate.keys()).sort();
      const getCell = (ymd,col) => ((byDate.get(ymd)||{})[col]) || "";
      function isoWeekKey(date){ return `${isoWeekYear(date)}-W${String(isoWeek(date)).padStart(2,"0")}`; }

      // === Scelta "a casa" ===
      const HOME_LS_KEY = 'home-events-v1';
      const HOME_ALL = ["ferie","riposo","rec","104","malattia","festivo"];
      const HOME_DEFAULT = ["ferie","riposo","104","malattia"];
      let homeSet = new Set(loadHomeArray());

      function loadHomeArray(){
        try{
          const j = JSON.parse(localStorage.getItem(HOME_LS_KEY)||'null');
          const arr = Array.isArray(j)? j.map(v=>String(v).toLowerCase()) : HOME_DEFAULT;
          return Array.from(new Set(arr.filter(v=>HOME_ALL.includes(v))));
        }catch{ return HOME_DEFAULT; }
      }
      function saveHome(){ localStorage.setItem(HOME_LS_KEY, JSON.stringify(Array.from(homeSet))); }
      function isHomeDynamic(val){ return homeSet.has((val||"").toString().toLowerCase()); }

      function renderHomeChooser(){
        const host = document.getElementById('homeChooser');
        host.innerHTML = HOME_ALL.map(k=>{
          const id = `home-${k}`;
          const label = k.toUpperCase();
          const checked = homeSet.has(k) ? ' checked' : '';
          return `<label for="${id}"><input type="checkbox" id="${id}" value="${k}"${checked}/> ${label}</label>`;
        }).join('');
        host.querySelectorAll('input[type="checkbox"]').forEach(chk=>{
          chk.addEventListener('change', ()=>{
            const val = chk.value.toLowerCase();
            if (chk.checked) homeSet.add(val); else homeSet.delete(val);
            if (homeSet.size===0){ homeSet = new Set(HOME_DEFAULT); renderHomeChooser(); }
            saveHome();
            recomputeHistoricEvents();
            buildRowsAndMetrics();
            try{ evaluatePlan(); }catch(_){}; 
          });
        });
      }

      // === Regole evento-domenica (con H/I nuovi) ===
      const RULE_KEYS = ["A","B","C","D","E","F","G","H","I"];
      const RULE_LABELS = {
        A: 'Venerd√¨ + Sabato + Domenica tutti ‚Äúa casa‚Äù',
        B: 'Sabato + Domenica + Luned√¨ tutti ‚Äúa casa‚Äù',
        C: 'Sabato + Domenica entrambi ‚Äúa casa‚Äù',
        D: 'Domenica + Luned√¨ entrambi ‚Äúa casa‚Äù',
        E: 'Domenica ‚Äúa casa‚Äù + luned√¨ successivo festivo',
        F: 'Venerd√¨ festivo + Sabato ‚Äúa casa‚Äù + Domenica ‚Äúa casa‚Äù',
        G: 'Sabato + Domenica ‚Äúa casa‚Äù + luned√¨ successivo festivo',
        H: 'Solo Sabato ‚Äúa casa‚Äù',
        I: 'Solo Domenica ‚Äúa casa‚Äù'
      };
      // default: A..G on, H/I off
      const RULE_DEFAULT = new Set(["A","B","C","D","E","F","G"]);
      const RULE_LS_KEY = "weekend-rule-flags-v2";

      let ruleSet = loadRuleSet();
      function loadRuleSet(){
        try{
          const raw = JSON.parse(localStorage.getItem(RULE_LS_KEY) || "null");
          if (Array.isArray(raw)){
            const s = new Set(raw.filter(k => RULE_KEYS.includes(k)));
            return s.size ? s : new Set(RULE_DEFAULT);
          }
          return new Set(RULE_DEFAULT);
        } catch {
          return new Set(RULE_DEFAULT);
        }
      }
      function saveRuleSet(){ localStorage.setItem(RULE_LS_KEY, JSON.stringify(Array.from(ruleSet))); }
      function isRuleEnabled(key){ return ruleSet.has(key); }

      // Checkbox dentro alle frasi (a sinistra)
      function renderRulesList(){
        const host = document.getElementById("rulesList");
        if (!host) return;
        host.innerHTML = [
          "A","B","C","D","E","F","G","H","I"
        ].map(k=>{
          const checked = isRuleEnabled(k) ? ' checked' : '';
          return `<li>
            <input type="checkbox" id="rule-${k}" value="${k}"${checked} />
            <label for="rule-${k}"><b>${k})</b> ${RULE_LABELS[k]}</label>
          </li>`;
        }).join("");
        host.querySelectorAll('input[type="checkbox"]').forEach(chk=>{
          chk.addEventListener('change', ()=>{
            const k = chk.value;
            if (chk.checked) ruleSet.add(k); else ruleSet.delete(k);
            saveRuleSet();
            recomputeHistoricEvents();
            buildRowsAndMetrics();
            try{ evaluatePlan(); }catch(_){}
          });
        });
      }

      // Eventi ‚Äúa casa‚Äù storici (ancorati alla domenica)
      function recomputeHistoricEvents(){
        for (const col of dipCols){ stats[col].eventsWeeksAll = new Set(); }
        for (const ymd of allDates){
          const d = new Date(ymd);
          if (d.getDay() !== 0) continue; // solo domeniche
          const sun = d, sat = addDays(sun,-1), fri = addDays(sun,-2), mon = addDays(sun,1);
          const wKey = isoWeekKey(sun);

          for (const col of dipCols){
            const friVal = getCell(toYMD(fri), col);
            const satVal = getCell(toYMD(sat), col);
            const sunVal = getCell(toYMD(sun), col);
            const monVal = getCell(toYMD(mon), col);

            const friHome = isHomeDynamic(friVal);
            const satHome = isHomeDynamic(satVal);
            const sunHome = isHomeDynamic(sunVal);
            const monHome = isHomeDynamic(monVal);

            const friFestivo = (friVal || "").toLowerCase() === 'festivo';
            const monFestivo = (monVal || "").toLowerCase() === 'festivo';

            // condizioni originarie
            const condA = friHome && satHome && sunHome;          // Ven+Sab+Dom "a casa"
            const condB = satHome && sunHome && monHome;          // Sab+Dom+Lun "a casa"
            const condC = sunHome && monHome;                     // Dom+Lun "a casa"
            const condD = sunHome && monFestivo;                  // Dom "a casa" + lun festivo
            const condE = friFestivo && satHome && sunHome;       // Ven festivo + Sab "a casa" + Dom "a casa"
            const condF = satHome && sunHome && monFestivo;       // Sab+Dom "a casa" + lun festivo
            const condG = satHome && sunHome;                     // Sab+Dom "a casa"
            // nuove
            const condH = satHome;                                // Solo Sabato "a casa"
            const condI = sunHome;                                // Solo Domenica "a casa"

            const triggers = [
              isRuleEnabled("A") && condA,
              isRuleEnabled("B") && condB,
              isRuleEnabled("C") && condG,
              isRuleEnabled("D") && condC,
              isRuleEnabled("E") && condD,
              isRuleEnabled("F") && condE,
              isRuleEnabled("G") && condF,
              isRuleEnabled("H") && condH,
              isRuleEnabled("I") && condI
            ];

            if (triggers.some(Boolean)){
              stats[col].eventsWeeksAll.add(wKey);
            }
          }
        }
      }

      // Riepilogo + Note
      const today = new Date();
      const curW = isoWeek(today), curY = isoWeekYear(today);
      const tbodyEl = document.getElementById("riepilogo");
      const notesBodyEl = document.getElementById("notesBody");

      const DOT_KEYS = new Set(["aperture","chiusure","apertureWEFest","chiusureWEFest","ferie","_eventsN"]);
      const headerIdByKey = {
        aperture:"th-ap", chiusure:"th-ch", apertureWEFest:"th-apwe", chiusureWEFest:"th-chwe",
        ferie:"th-fe", riposo:"th-ri", "104":"th-104", malattia:"th-ma", _eventsN:"th-evn"
      };

      function assessBalanceShares(values){
        const sum = values.reduce((a,b)=>a+b,0);
        if (sum <= 0) return { balanced:true, outIndex:null, shares:values.map(_=>0), spread:0, maxShare:0, minShare:0 };
        const shares = values.map(v => v / sum);
        const maxShare = Math.max(...shares);
        const minShare = Math.min(...shares);
        const spread = maxShare - minShare;
        const balanced = spread <= 0.05;
        let outIndex = null;
        if (!balanced){
          const mean = 1 / shares.length;
          const idxMax = shares.indexOf(maxShare);
          const idxMin = shares.indexOf(minShare);
          outIndex = (maxShare - mean) >= (mean - minShare) ? idxMax : idxMin;
        }
        return { balanced, outIndex, shares, spread, maxShare, minShare };
      }
      function humanListBold(names){
        if (names.length === 1) return `<b>${names[0]}</b>`;
        if (names.length === 2) return `<b>${names[0]}</b> e <b>${names[1]}</b>`;
        return names.slice(0,-1).map(n=>`<b>${n}</b>`).join(", ") + ` e <b>${names.slice(-1)[0]}</b>`;
      }
      function adviceObjective(values, labels, what){
        const st = assessBalanceShares(values);
        if (st.balanced) return `${what}: distribuzione bilanciata ‚Äî nessuna azione specifica.`;
        const sum = values.reduce((a,b)=>a+b,0);
        const shares = sum>0 ? values.map(v => v/sum) : values.map(_=>0);
        const max = Math.max(...shares), min = Math.min(...shares);
        const maxGroup = labels.filter((_,i)=>shares[i]===max);
        const minGroup = labels.filter((_,i)=>shares[i]===min);
        const isHighOut = (st.outIndex !== null) && (shares[st.outIndex] === max);
        return isHighOut
          ? `${what}: diminuire a ${humanListBold(maxGroup)} ‚Ä¢ aumentare a ${humanListBold(minGroup)}`
          : `${what}: aumentare a ${humanListBold(minGroup)} ‚Ä¢ diminuire a ${humanListBold(maxGroup)}`;
      }

      let rowsRender=[], perMetricValues={}, columnStatus={};
      function buildRowsAndMetrics(){
        rowsRender = dipendenti.map(d => {
          const s = stats[d];
          const weeksThisYearUpToNow = Array.from(s.eventsWeeksAll)
            .map(k => { const [yPart,wPart] = k.split("-W"); return { y:+yPart, w:+wPart }; })
            .filter(o => o.y === curY && o.w <= curW)
            .sort((a,b)=>a.w-b.w);
          const nEvents = weeksThisYearUpToNow.length;
          const perc = curW > 0 ? (nEvents / curW) * 100 : 0;
          return {
            dip:d,
            aperture:s.aperture,
            chiusure:s.chiusure,
            apertureWEFest:s.apertureWEFest,
            chiusureWEFest:s.chiusureWEFest,
            ferie:s.ferie, riposo:s.riposo, "104":s["104"], malattia:s.malattia,
            _eventsN:nEvents, _eventsPct:perc, _weeksList: weeksThisYearUpToNow.map(o=>o.w).join(", ") || "‚Äî"
          };
        });

        perMetricValues = {};
        Object.keys(headerIdByKey).forEach(k => perMetricValues[k] = rowsRender.map(r => r[k]));

        columnStatus = {};
        for (const key of DOT_KEYS){
          const vals = perMetricValues[key];
          const st = assessBalanceShares(vals);
          columnStatus[key] = st;
          const th = document.getElementById(headerIdByKey[key]);
          th?.classList.remove("balanced-col","balanced-outline");
          if (st.balanced) th?.classList.add("balanced-col","balanced-outline");
        }

        tbodyEl.innerHTML = rowsRender.map((r, rowIdx) => {
          function cell(key, extraCls="", isNum=true){
            const isDotCol = DOT_KEYS.has(key);
            const st = isDotCol ? columnStatus[key] : null;
            const val = r[key];
            const ringCls = (!st || st.balanced || st.outIndex !== rowIdx) ? 'ring' : 'ring red';
            const tdCls = ['num'];
            if (extraCls) tdCls.push(extraCls);
            if (isDotCol && st && st.balanced) tdCls.push('balanced-col','balanced-outline');
            const content = isNum ? `<span class="${ringCls}">${val}</span>` : val;
            return `<td class="${tdCls.join(' ')}">${content}</td>`;
          }
          return `<tr>
            <td>${r.dip}</td>
            ${cell("aperture")}
            ${cell("chiusure")}
            ${cell("apertureWEFest")}
            ${cell("chiusureWEFest")}
            ${cell("ferie")}
            ${cell("riposo")}
            ${cell("104")}
            ${cell("malattia")}
            ${cell("_eventsN","focus focus-start")}
            <td class="num focus"><span class="ring">${r._eventsPct.toFixed(1)}%</span></td>
            <td class="weeks focus focus-end">${r._weeksList}</td>
          </tr>`;
        }).join("");

        const labels = dipendenti;
        const notes = [
          adviceObjective(perMetricValues["aperture"], labels, "Aperture"),
          adviceObjective(perMetricValues["chiusure"], labels, "Chiusure"),
          adviceObjective(perMetricValues["apertureWEFest"], labels, "Aperture nel weekend/festivi"),
          adviceObjective(perMetricValues["chiusureWEFest"], labels, "Chiusure nel weekend/festivi"),
          adviceObjective(perMetricValues["_eventsN"], labels, 'Eventi "a casa"')
        ];
        notesBodyEl.innerHTML = notes.map(n => {
          const [title, ...rest] = n.split(": ");
          return `<tr><td><b>${title}</b></td><td>${rest.join(": ")}</td></tr>`;
        }).join("");
      }

      // Avvio storico + UI
      renderHomeChooser();
      renderRulesList();
      recomputeHistoricEvents();
      buildRowsAndMetrics();

      // === PLANNER ===
      const plannerHead = document.getElementById('plannerHead');
      const plannerBody = document.getElementById('plannerBody');
      const plannerRange = document.getElementById('plannerRange');
      const plannerStatus = document.getElementById('plannerStatus');
      const btnEval = document.getElementById('btnEval');
      const btnReset = document.getElementById('btnReset');

      const baseMonday = startOfISOWeek(maxDate || new Date());
      const nextMonday = addDays(baseMonday, 7);
      const days7 = Array.from({length:7}, (_,i)=> addDays(nextMonday, i));
      const daysYMD = days7.map(d => toYMD(d));
      const fmt = new Intl.DateTimeFormat('it-IT', { weekday:'short', day:'2-digit', month:'2-digit' });
      plannerRange.textContent = `Settimana: ${fmt.format(days7[0])} ‚Üí ${fmt.format(days7[6])}`;

      plannerHead.innerHTML = `<tr>
        <th>Dipendente</th>
        ${days7.map(d=>`<th>${fmt.format(d)}</th>`).join("")}
      </tr>`;

      const OPTIONS = ["", "apertura", "chiusura", "rec", "riposo", "104", "festivo", "malattia", "ferie"];

      const LS_KEY = `planner-${daysYMD[0]}-${daysYMD[6]}`;
      function loadPlan(){ try{ return JSON.parse(localStorage.getItem(LS_KEY) || '{}'); }catch{ return {}; } }
      function savePlan(plan){ localStorage.setItem(LS_KEY, JSON.stringify(plan)); }

      const saved = loadPlan();
      function renderPlanner(){
        plannerBody.innerHTML = dipendenti.map((dName)=>{
          const row = [`<td>${dName}</td>`];
          for (let c=0;c<7;c++){
            const ymd = daysYMD[c];
            const cur = (saved[dName] && saved[dName][ymd]) || "";
            const sel = `<select data-emp="${dName}" data-ymd="${ymd}">` + OPTIONS.map(opt=>{
              const label = opt ? opt.toUpperCase() : "‚Äî";
              const val = opt;
              const chosen = (cur===val) ? ' selected' : '';
              return `<option value="${val}"${chosen}>${label}</option>`;
            }).join("") + `</select>`;
            row.push(`<td>${sel}</td>`);
          }
          return `<tr>${row.join("")}</tr>`;
        }).join("");

        plannerBody.querySelectorAll('select').forEach(sel =>{
          sel.addEventListener('change', ()=>{
            const emp = sel.dataset.emp; const ymd = sel.dataset.ymd; const val = sel.value;
            if(!saved[emp]) saved[emp] = {};
            saved[emp][ymd] = val;
            savePlan(saved);
          });
        });
      }
      renderPlanner();

      btnReset.addEventListener('click', ()=>{
        localStorage.removeItem(LS_KEY);
        for(const k in saved) delete saved[k];
        renderPlanner();
        plannerStatus.textContent = 'Pianificazione azzerata';
        plannerStatus.className = 'pill warn';
        document.getElementById('planFeedback').innerHTML = '';
        document.getElementById('planSummary').textContent = '‚Äî';
      });

      function computePlanStats(){
        const pStats = {};
        dipendenti.forEach(d => pStats[d] = {
          aperture:0, chiusure:0,
          apertureWEFest:0, chiusureWEFest:0,
          ferie:0, riposo:0, "104":0, malattia:0,
          eventsWeeksAll: new Set()
        });

        const isHomePlan = (v) => isHomeDynamic(v);

        for (let i=0;i<7;i++){
          const d = days7[i]; const ymd = daysYMD[i];
          const dow = d.getDay();
          const weekend = (dow===0 || dow===6);

          for (const emp of dipendenti){
            const v = (saved[emp] && saved[emp][ymd]) || "";
            if (!v) continue;
            const festivoFromPlan = (v === 'festivo');
            if (v === 'apertura'){
              pStats[emp].aperture++; if (weekend || festivoFromPlan) pStats[emp].apertureWEFest++;
            } else if (v === 'chiusura'){
              pStats[emp].chiusure++; if (weekend || festivoFromPlan) pStats[emp].chiusureWEFest++;
            } else if (v === 'ferie'){
              pStats[emp].ferie++;
            } else if (v === 'riposo'){
              pStats[emp].riposo++;
            } else if (v === '104'){
              pStats[emp]["104"]++;
            } else if (v === 'malattia'){
              pStats[emp].malattia++;
            }
          }
        }

        // Eventi lunghi (ancorati alla domenica corrente del planner)
        const sun = days7[6];
        const sat = days7[5];
        const fri = days7[4];
        const nextMon = addDays(sun, 1);
        const yFri = toYMD(fri), ySat = toYMD(sat), ySun = toYMD(sun), yMon = toYMD(nextMon);
        const wKey = `${isoWeekYear(sun)}-W${String(isoWeek(sun)).padStart(2,'0')}`;

        const getPlanVal = (emp, ymd) => (saved[emp] && saved[emp][ymd]) || "";

        for (const emp of dipendenti){
          const friVal = getPlanVal(emp, yFri);
          const satVal = getPlanVal(emp, ySat);
          const sunVal = getPlanVal(emp, ySun);
          const monVal = getPlanVal(emp, yMon);

          const friHome = isHomePlan(friVal);
          const satHome = isHomePlan(satVal);
          const sunHome = isHomePlan(sunVal);
          const monHome = isHomePlan(monVal);

          const friFestivo = (friVal || '').toLowerCase() === 'festivo';
          const monFestivo = (monVal || '').toLowerCase() === 'festivo';

          // condizioni originarie
          const condA = friHome && satHome && sunHome;
          const condB = satHome && sunHome && monHome;
          const condC = sunHome && monHome;
          const condD = sunHome && monFestivo;
          const condE = friFestivo && satHome && sunHome;
          const condF = satHome && sunHome && monFestivo;
          const condG = satHome && sunHome;
          // nuove
          const condH = satHome;
          const condI = sunHome;

          const triggers = [
            isRuleEnabled("A") && condA,
            isRuleEnabled("B") && condB,
            isRuleEnabled("C") && condG,
            isRuleEnabled("D") && condC,
            isRuleEnabled("E") && condD,
            isRuleEnabled("F") && condE,
            isRuleEnabled("G") && condF,
            isRuleEnabled("H") && condH,
            isRuleEnabled("I") && condI
          ];

          if (triggers.some(Boolean)){
            pStats[emp].eventsWeeksAll.add(wKey);
          }
        }

        return pStats;
      }

      function evaluatePlan(){
        const pStats = computePlanStats();
        const cumulative = document.getElementById('chkCumulative')?.checked;

        const METRICS = [
          { key:'aperture', label:'Aperture' },
          { key:'chiusure', label:'Chiusure' },
          { key:'apertureWEFest', label:'Aperture nel weekend/festivi' },
          { key:'chiusureWEFest', label:'Chiusure nel weekend/festivi' },
          { key:'_eventsN', label:'Eventi "a casa"' }
        ];

        const hist = {}; const plan = {};
        for (const m of METRICS){
          if (m.key === '_eventsN'){
            hist[m.key] = dipendenti.map(d => {
              const s = stats[d].eventsWeeksAll;
              const arr = Array.from(s).map(k => { const [y,w]=k.split('-W'); return {y:+y,w:+w}; });
              return arr.filter(o=>o.y===isoWeekYear(new Date()) && o.w<=isoWeek(new Date())).length;
            });
            plan[m.key] = dipendenti.map(d => (pStats[d].eventsWeeksAll.size || 0));
          } else {
            hist[m.key] = dipendenti.map(d => (stats[d][m.key] || 0));
            plan[m.key] = dipendenti.map(d => (pStats[d][m.key] || 0));
          }
        }

        const arrSum = a => a.reduce((x,y)=>x+y,0);
        const shares = values => { const s = arrSum(values); return s>0 ? values.map(v=>v/s) : values.map(_=>0); };
        const EPS = 1e-6;

        let improved=0, worsened=0, neutral=0;
        const rows = [];

        for (const m of METRICS){
          const h = hist[m.key];
          const p = plan[m.key];

          if (arrSum(p) === 0){
            rows.push({label:m.label, icon:'‚ÑπÔ∏è', verdict:'Nessun evento pianificato per questa voce'}); 
            neutral++; 
            continue;
          }

          const x = cumulative ? h.map((v,i)=>v + p[i]) : p.slice();

          const stH = assessBalanceShares(h);
          const stX = assessBalanceShares(x);
          const shrH = shares(h);
          const shrX = shares(x);

          const idxMaxH = shrH.indexOf(Math.max(...shrH));
          const idxMinH = shrH.indexOf(Math.min(...shrH));
          const idxMaxX = shrX.indexOf(Math.max(...shrX));
          const idxMinX = shrX.indexOf(Math.min(...shrX));

          const arrowMax = shrX[idxMaxH] < shrH[idxMaxH] - EPS ? '‚Üì' : (Math.abs(shrX[idxMaxH]-shrH[idxMaxH])<=EPS ? '‚Üí' : '‚Üë');
          const arrowMin = shrX[idxMinH] > shrH[idxMinH] + EPS ? '‚Üë' : (Math.abs(shrX[idxMinH]-shrH[idxMinH])<=EPS ? '‚Üí' : '‚Üì');

          let icon, verdict;
          if (stX.spread < stH.spread - EPS){
            icon = '‚úÖ';
            verdict = `Spread ${(stH.spread*100).toFixed(1)}pp ‚Üí ${(stX.spread*100).toFixed(1)}pp ‚Ä¢ Storico: max ${dipendenti[idxMaxH]}, min ${dipendenti[idxMinH]} ‚Üí ${cumulative?'Cumulato':'Piano'}: max ${dipendenti[idxMaxX]}, min ${dipendenti[idxMinX]} ‚Ä¢ ${arrowMax} ${dipendenti[idxMaxH]} ‚Ä¢ ${arrowMin} ${dipendenti[idxMinH]}`;
            improved++;
          } else if (stX.spread > stH.spread + EPS){
            icon = '‚ùå';
            verdict = `Spread aumentato: ${(stH.spread*100).toFixed(1)}pp ‚Üí ${(stX.spread*100).toFixed(1)}pp ‚Ä¢ ${arrowMax} ${dipendenti[idxMaxH]} ‚Ä¢ ${arrowMin} ${dipendenti[idxMinH]}`;
            worsened++;
          } else {
            icon = '‚ö†Ô∏è';
            verdict = `Spread invariato: ${(stH.spread*100).toFixed(1)}pp ‚Ä¢ ${arrowMax} ${dipendenti[idxMaxH]} ‚Ä¢ ${arrowMin} ${dipendenti[idxMinH]}`;
            neutral++;
          }

          rows.push({label:m.label, icon, verdict});
        }

        document.getElementById('planFeedback').innerHTML =
          rows.map(r => `<tr><td><b>${r.label}</b></td><td style="width:80px">${r.icon}</td><td>${r.verdict}</td></tr>`).join('');
        const total = improved + worsened + neutral;
        const pillClass = worsened===0 && improved>0 ? 'pill ok' : (worsened>0 ? 'pill bad' : 'pill warn');
        plannerStatus.className = pillClass;
        plannerStatus.textContent = worsened===0 && improved>0 ? 'Congruit√† buona' : (worsened>0 ? 'Congruit√† da rivedere' : 'Congruit√† neutra');
        document.getElementById('planSummary').textContent =
          `Miglioramenti: ${improved}/${total} ‚Ä¢ Peggioramenti: ${worsened}/${total} ‚Ä¢ Neutre: ${neutral}/${total}`;
      }

      btnEval.addEventListener('click', evaluatePlan);

      // === CONVALIDA & SCRITTURA SU GOOGLE SHEET ===
      function buildPlannerEntries() {
        const entries = [];
        for (let i = 0; i < daysYMD.length; i++) {
          const ymd = daysYMD[i];
          for (const emp of dipendenti) {
            const v = (saved[emp] && saved[emp][ymd]) || "";
            if (v && v.trim()) entries.push({ date: ymd, employee: emp, value: v.trim().toLowerCase() });
          }
        }
        return entries;
      }

      async function savePlanToSheet() {
        const btn = document.getElementById('btnSave');
        btn.disabled = true;
        btn.textContent = 'Invio in corso‚Ä¶';

        const payload = {
          token: SAVE_TOKEN,
          gid, // stessa scheda
          week: { start: daysYMD[0], end: daysYMD[6] },
          employees: dipendenti,
          entries: buildPlannerEntries()
        };

        try {
          const res = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(payload)
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const out = await res.json();
          if (!out.ok) throw new Error(out.error || 'Errore server');

          plannerStatus.className = 'pill ok';
          plannerStatus.textContent = `Convalidato: scritte ${out.updated} celle in "${out.sheetName}"`;
          plannerBody.querySelectorAll('select').forEach(s => s.disabled = true);
          btn.textContent = 'Convalidato ‚úÖ';
        } catch (err) {
          console.error(err);
          plannerStatus.className = 'pill bad';
          plannerStatus.textContent = `Errore scrittura: ${err.message}`;
          btn.textContent = 'Riprova';
          btn.disabled = false;
        }
      }

      document.getElementById('btnSave').addEventListener('click', savePlanToSheet);

    })().catch(err=>{
      console.error(err);
      alert("Errore: " + err.message +
        "\n- Il documento resta pubblicato come pagina web (OK).\n- Lettura via export CSV della stessa scheda.");
    });
  </script>
</body>
</html>
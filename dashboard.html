<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Statistiche Orari Profumeria</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root {
      --bg:#f6f7fb; --card:#ffffff; --border:#e6e8f0; --muted:#6b7280; --ink:#0f172a;
      --head:#0b1220; --accent:#16a34a; --danger:#dc2626; --balanced-bg:#ebfbee; --balanced-br:#86efac;
    }
    * { box-sizing: border-box; }
    body {
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg); color:var(--ink); line-height:1.4;
    }
    header { position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid var(--border); }
    .wrap { max-width:1200px; margin:0 auto; padding:18px 20px; }
    h1 { margin:0; font-size:22px; color:var(--head); }
    .sub { color:var(--muted); font-size:13px; margin-top:6px; }
    .badges { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .badge {
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--border);
      background:var(--card); border-radius:999px; font-size:12px; color:#0f172a;
    }

    main.wrap { display:flex; flex-direction:column; gap:18px; }

    .card {
      background:var(--card); border:1px solid var(--border); border-radius:16px;
      box-shadow: 0 1px 6px rgba(0,0,0,.04);
    }
    .card-header { padding:14px 16px; border-bottom:1px solid var(--border); }
    .card-title { margin:0; font-size:16px; color:var(--head); }
    .card-body { padding:12px 16px; }

    .table-wrap { border:1px solid var(--border); border-radius:12px; overflow:auto; max-height:70vh; background:#fff; }
    table { width:100%; border-collapse:separate; border-spacing:0; font-size:15px; }
    thead th {
      position:sticky; top:0; background:#fff; z-index:1; color:#0b1220;
      border-bottom:1px solid var(--border); font-weight:700; padding:12px 10px;
    }
    tbody td { padding:12px 10px; border-bottom:1px solid var(--border); }
    tbody tr:nth-child(even){ background:#fafafa; }
    tbody tr:hover { background:#f1f5f9; }
    th:first-child, td:first-child { text-align:left; width:180px; }
    /* numeri centrati come richiesto */
    .num { text-align:center; font-variant-numeric: tabular-nums; white-space:nowrap; }
    .weeks { text-align:left; white-space:normal; max-width:320px; }

    /* cerchietto rosso attorno al numero (bollino) */
    .ring { display:inline-block; padding:2px 8px; border:2px solid transparent; border-radius:9999px; line-height:1; }
    .ring.red { border-color: var(--danger); }

    /* colonna bilanciata ‚Üí verde tenue */
    .balanced-col { background:var(--balanced-bg) !important; }
    th.balanced-col { border-bottom-color:var(--balanced-br); }
    .balanced-outline { box-shadow: inset 2px 0 0 var(--balanced-br), inset -2px 0 0 var(--balanced-br); }

    .legend { font-size:14px; color:#111; }
    .legend h3 { margin:0 0 10px; font-size:15px; color:var(--head); }
    .legend ul { margin:6px 0 12px 18px; padding:0; }
    .legend li { margin:6px 0; }
    .legend .muted { color:var(--muted); font-size:12px; }

    /* Tabella note */
    .notes table { width:100%; border-collapse:separate; border-spacing:0; font-size:15px; }
    .notes th, .notes td { padding:10px 8px; border-bottom:1px solid var(--border); }
    .notes thead th { background:#fff; position:sticky; top:0; z-index:1; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>üìä Statistiche Orari Profumeria</h1>
      <div class="sub">Dati dal foglio Google pubblicato (lettura automatica, nessuna modifica alla condivisione).</div>
      <div class="badges">
        <div class="badge" id="isoBadge">Settimana ISO: ‚Ä¶</div>
        <div class="badge" id="updBadge">Aggiornato: ‚Ä¶</div>
      </div>
    </div>
  </header>

  <main class="wrap" aria-live="polite">
    <!-- TABELLONE -->
    <section class="card" aria-label="Riepilogo per dipendente">
      <div class="card-header"><h2 class="card-title">Riepilogo per dipendente</h2></div>
      <div class="card-body">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Dipendente</th>
                <th id="th-ap">Aperture</th>
                <th id="th-ch">Chiusure</th>
                <th id="th-apwe">Aperture WE/Festivi</th>
                <th id="th-chwe">Chiusure WE/Festivi</th>
                <th id="th-fe">Ferie</th>
                <th id="th-ri">Riposo</th>
                <th id="th-104">104</th>
                <th id="th-ma">Malattia</th>
                <th id="th-evn">Eventi ‚Äúa casa‚Äù (n)</th>
                <th>Eventi ‚Äúa casa‚Äù (%)</th>
                <th>Settimane (ISO) eventi</th>
              </tr>
            </thead>
            <tbody id="riepilogo"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- LEGENDA (sotto la tabella) -->
    <section class="card" id="legend">
      <div class="card-header"><h2 class="card-title">Legenda & criteri di calcolo</h2></div>
      <div class="card-body legend">
        <h3>Eventi ‚Äúa casa‚Äù</h3>
        <ul>
          <li><b>Conta come ‚Äúa casa‚Äù:</b> <code>FERIE</code>, <code>RIPOSO</code>, <code>104</code>, <code>MALATTIA</code>.</li>
          <li><b>Settimana ISO</b>: luned√¨‚Äìdomenica (la settimana 01 √® quella che contiene il 4 gennaio).</li>
          <li><b>Scatta un evento (ancorato alla domenica) se si verifica almeno uno tra:</b>
            <ul>
              <li><b>Venerd√¨ + Sabato + Domenica</b> tutti e tre ‚Äúa casa‚Äù.</li>
              <li><b>Sabato + Domenica + Luned√¨</b> tutti e tre ‚Äúa casa‚Äù.</li>
              <li><b>Domenica + Luned√¨</b> entrambi ‚Äúa casa‚Äù.</li>
              <li><b>Domenica</b> ‚Äúa casa‚Äù + <b>luned√¨ successivo festivo</b>.</li>
              <li><b>Venerd√¨ festivo</b> + <b>Sabato</b> ‚Äúa casa‚Äù + <b>Domenica</b> ‚Äúa casa‚Äù.</li>
              <li><b>Sabato + Domenica</b> entrambi ‚Äúa casa‚Äù + <b>luned√¨ successivo festivo</b>.</li>
            </ul>
          </li>
        </ul>

        <h3>Bollini e bilanciamento</h3>
        <ul>
          <li><span class="ring red">‚óè</span> = <b>outlier</b> (valore pi√π sbilanciato, alto o basso). Al massimo <b>uno</b> per colonna.</li>
          <li><b>Colonna verde</b> = differenze irrilevanti: ogni quota <code>val/somma</code> √® entro ¬±15 punti percentuali dalla ripartizione equa.</li>
        </ul>
      </div>
    </section>

    <!-- NOTE PROSSIMA SETTIMANA -->
    <section class="card notes" aria-label="Note per Orari della prossima settimana">
      <div class="card-header"><h2 class="card-title">Note per Orari della prossima settimana</h2></div>
      <div class="card-body">
        <div class="table-wrap" style="max-height:50vh;">
          <table>
            <thead>
              <tr>
                <th>Voce</th>
                <th>Consiglio</th>
              </tr>
            </thead>
            <tbody id="notesBody"></tbody>
          </table>
        </div>
        <div class="sub" style="margin-top:8px;">
          Le note sono derivate dai totali attuali per bilanciare la ripartizione nella prossima settimana.
        </div>
      </div>
    </section>
  </main>

  <script>
    // Link pubhtml (immutato)
    const PUBHTML = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTiGFO5sDWqthBzsCJ08wsG5bM4BjidbyZBwRXt32IuAkcr0BWhCmSTA-ZyayT07w/pubhtml?gid=876412715&single=true";

    function getPubInfo(pubhtml){
      const idm = pubhtml.match(/\/d\/e\/([^/]+)\/pubhtml/);
      if(!idm) throw new Error("PUB_ID non riconosciuto nel link.");
      const gidm = pubhtml.match(/[?&]gid=(\d+)/);
      return { pubId: idm[1], gid: gidm ? gidm[1] : "0" };
    }
    async function fetchCSV(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error(`Fetch failed ${r.status}`);
      const text = await r.text();
      const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
      if (parsed.errors.length) console.warn("PapaParse errors:", parsed.errors);
      return parsed.data;
    }

    // Date utils
    function parseItaDate(dstr){
      if (!dstr) return null;
      if (/^\d{4}-\d{2}-\d{2}$/.test(dstr)) return new Date(dstr);
      const m = dstr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (!m) return new Date(dstr);
      return new Date(+m[3], +m[2]-1, +m[1]);
    }
    function toYMD(d){ return d.toISOString().slice(0,10); }
    function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

    // ISO week number + ISO week year
    function isoWeek(date){
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const day = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - day);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }
    function isoWeekYear(date){
      const d = new Date(date.getTime());
      d.setDate(d.getDate() + 4 - (d.getDay() || 7));
      return d.getFullYear();
    }

    // Pasqua + Festivi ITA
    function easterSunday(year){
      const a=year%19,b=Math.floor(year/100),c=year%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25);
      const g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451);
      const month=Math.floor((h+l-7*m+114)/31), day=((h+l-7*m+114)%31)+1;
      return new Date(year, month-1, day);
    }
    function italianHolidays(year){
      const set=new Set(); const add=(m,d)=>set.add(toYMD(new Date(year,m-1,d)));
      add(1,1); add(1,6); add(4,25); add(5,1); add(6,2); add(8,15); add(11,1); add(12,8); add(12,25); add(12,26);
      const easter=easterSunday(year), pasquetta=addDays(easter,1);
      set.add(toYMD(easter)); set.add(toYMD(pasquetta));
      return set;
    }
    function isHoliday(date, holidaysMap){
      const y=date.getFullYear();
      if(!holidaysMap.has(y)) holidaysMap.set(y, italianHolidays(y));
      return holidaysMap.get(y).has(toYMD(date));
    }

    (async function main(){
      // Badges
      const now = new Date();
      document.getElementById("isoBadge").textContent = `Settimana ISO: ${isoWeek(now)}/${isoWeekYear(now)}`;
      document.getElementById("updBadge").textContent = `Aggiornato: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;

      const { pubId, gid } = getPubInfo(PUBHTML);
      let csvUrl = `https://docs.google.com/spreadsheets/d/e/${pubId}/pub?gid=${gid}&single=true&output=csv`;
      let rows;
      try { rows = await fetchCSV(csvUrl); }
      catch(e1){ csvUrl = `https://docs.google.com/spreadsheets/d/e/${pubId}/gviz/tq?gid=${gid}&tqx=out:csv`; rows = await fetchCSV(csvUrl); }

      const headerKeys = rows.length ? Object.keys(rows[0]) : [];
      const colData = headerKeys.find(k => k.toLowerCase().includes("data"));
      if (!colData) throw new Error("Colonna 'Data' non trovata.");
      const dipCols = headerKeys.filter(k => /ilenia|cinzia|michela|vivien/i.test(k));
      const dipendenti = dipCols.slice();

      // Indice per data
      const byDate = new Map(); // YYYY-MM-DD -> { col: valueLower }
      const holidaysMap = new Map();

      // Stat
      const stats = {};
      dipendenti.forEach(d => stats[d] = {
        aperture:0, chiusure:0,
        apertureWEFest:0, chiusureWEFest:0,
        ferie:0, riposo:0, "104":0, malattia:0,
        eventsWeeksAll: new Set()
      });

      // Conteggi base + indice
      for (const row of rows){
        const dt = parseItaDate(row[colData]);
        if (!dt || isNaN(+dt)) continue;
        const ymd = toYMD(dt);
        const dow = dt.getDay(); // 0=dom,6=sab
        const weekend = (dow===0 || dow===6);
        const festivo = isHoliday(dt, holidaysMap);
        if (!byDate.has(ymd)) byDate.set(ymd, {});
        const dayObj = byDate.get(ymd);

        for (const col of dipCols){
          const raw = (row[col] || "").toString().trim().toLowerCase();
          dayObj[col] = raw;

          if (!raw) continue;
          if (raw === "apertura") {
            stats[col].aperture++;
            if (weekend || festivo) stats[col].apertureWEFest++;
          } else if (raw === "chiusura") {
            stats[col].chiusure++;
            if (weekend || festivo) stats[col].chiusureWEFest++;
          } else if (raw === "ferie") {
            stats[col].ferie++;
          } else if (raw === "riposo") {
            stats[col].riposo++;
          } else if (raw === "104") {
            stats[col]["104"]++;
          } else if (raw === "malattia") {
            stats[col].malattia++;
          }
        }
      }

      // Helper ‚Äúa casa‚Äù
      const isHome = (val) => ["ferie","riposo","104","malattia"].includes((val||"").toString().toLowerCase());
      const allDates = Array.from(byDate.keys()).sort();
      const get = (ymd,col) => ((byDate.get(ymd)||{})[col]) || "";

      function isoWeekKey(date){ return `${isoWeekYear(date)}-W${String(isoWeek(date)).padStart(2,"0")}`; }

      // Eventi ‚Äúa casa‚Äù ‚Äî combinazioni richieste (ancoraggio alla domenica)
      for (const ymd of allDates){
        const d = new Date(ymd);
        if (d.getDay() !== 0) continue; // solo domeniche
        const sun = d, sat = addDays(sun,-1), fri = addDays(sun,-2), mon = addDays(sun,1);
        const friHoliday = isHoliday(fri, holidaysMap);
        const monHoliday = isHoliday(mon, holidaysMap);
        const wKey = isoWeekKey(sun);

        for (const col of dipCols){
          const friHome = isHome(get(toYMD(fri), col));
          const satHome = isHome(get(toYMD(sat), col));
          const sunHome = isHome(get(toYMD(sun), col));
          const monHome = isHome(get(toYMD(mon), col));

          const condA = friHome && satHome && sunHome;                         // Ven+Sab+Dom a casa
          const condB = satHome && sunHome && monHome;                         // Sab+Dom+Lun a casa
          const condC = sunHome && monHome;                                    // Dom+Lun a casa
          const condD = sunHome && monHoliday;                                 // Dom a casa + Lun festivo
          const condE = friHoliday && satHome && sunHome;                      // Ven festivo + Sab a casa + Dom a casa
          const condF = satHome && sunHome && monHoliday;                      // Sab+Dom a casa + Lun festivo

          if (condA || condB || condC || condD || condE || condF){
            stats[col].eventsWeeksAll.add(wKey);
          }
        }
      }

      // % eventi a casa rispetto alla settimana ISO odierna (anno ISO corrente)
      const today = new Date();
      const curW = isoWeek(today), curY = isoWeekYear(today);

      // Righe da renderizzare
      const rowsRender = dipendenti.map(d => {
        const s = stats[d];
        const weeksThisYearUpToNow = Array.from(s.eventsWeeksAll)
          .map(k => { const [yPart,wPart] = k.split("-W"); return { y:+yPart, w:+wPart }; })
          .filter(o => o.y === curY && o.w <= curW)
          .sort((a,b)=>a.w-b.w);

        const nEvents = weeksThisYearUpToNow.length;
        const perc = curW > 0 ? (nEvents / curW) * 100 : 0;
        return {
          dip:d,
          aperture:s.aperture,
          chiusure:s.chiusure,
          apertureWEFest:s.apertureWEFest,
          chiusureWEFest:s.chiusureWEFest,
          ferie:s.ferie, riposo:s.riposo, "104":s["104"], malattia:s.malattia,
          _eventsN:nEvents, _eventsPct:perc, _weeksList: weeksThisYearUpToNow.map(o=>o.w).join(", ") || "‚Äî"
        };
      });

      // Colonne da valutare (per bollini & bilanciamento)
      const metrics = [
        { key:"aperture", th:"th-ap", label:"Aperture" },
        { key:"chiusure", th:"th-ch", label:"Chiusure" },
        { key:"apertureWEFest", th:"th-apwe", label:"Aperture WE/Festivi" },
        { key:"chiusureWEFest", th:"th-chwe", label:"Chiusure WE/Festivi" },
        { key:"ferie", th:"th-fe", label:"Ferie" },
        { key:"riposo", th:"th-ri", label:"Riposo" },
        { key:"104", th:"th-104", label:"104" },
        { key:"malattia", th:"th-ma", label:"Malattia" },
        { key:"_eventsN", th:"th-evn", label:"Eventi a casa (n)" }
      ];

// Colonna bilanciata se (maxShare - minShare) ‚â§ 0.15
// outlier = l'estremo (alto o basso) pi√π lontano dalla quota media (1/N)
function assessBalanceShares(values){
  const sum = values.reduce((a,b)=>a+b,0);
  if (sum <= 0) return { balanced:true, outIndex:null, shares:values.map(_=>0) };

  const shares = values.map(v => v / sum);
  const maxShare = Math.max(...shares);
  const minShare = Math.min(...shares);
  const balanced = (maxShare - minShare) <= 0.15; // 15 punti percentuali

  let outIndex = null;
  if (!balanced){
    const mean = 1 / shares.length;
    const idxMax = shares.indexOf(maxShare);
    const idxMin = shares.indexOf(minShare);
    // scegli l'estremo pi√π distante dalla media
    outIndex = (maxShare - mean) >= (mean - minShare) ? idxMax : idxMin;
  }
  return { balanced, outIndex, shares };
}


      // Calcola valori per metrica
      const perMetricValues = {};
      metrics.forEach(m => perMetricValues[m.key] = rowsRender.map(r => r[m.key]));

      // Stato colonne (bilanciate/outlier)
      const columnStatus = {};
      metrics.forEach(m => {
        const st = assessBalanceShares(perMetricValues[m.key]);
        columnStatus[m.key] = st;
        if (st.balanced) document.getElementById(m.th)?.classList.add("balanced-col","balanced-outline");
      });

      // Render tabella: aggiungo il cerchietto rosso attorno al numero solo all'outlier
      const tbody = document.getElementById("riepilogo");
      tbody.innerHTML = rowsRender.map((r, rowIdx) => {
        function cell(key, isNum=true){
          const st = columnStatus[key];
          const val = r[key];
          const ring = (!st.balanced && st.outIndex === rowIdx) ? ' ring red' : '';
          const tdCls = ['num'];
          if (st.balanced) tdCls.push('balanced-col','balanced-outline');
          const content = isNum ? `<span class="ring${ring}">${val}</span>` : val;
          return `<td class="${tdCls.join(' ')}">${content}</td>`;
        }
        return `<tr>
          <td>${r.dip}</td>
          ${cell("aperture")}
          ${cell("chiusure")}
          ${cell("apertureWEFest")}
          ${cell("chiusureWEFest")}
          ${cell("ferie")}
          ${cell("riposo")}
          ${cell("104")}
          ${cell("malattia")}
          ${cell("_eventsN")}
          <td class="num"><span class="ring">${r._eventsPct.toFixed(1)}%</span></td>
          <td class="weeks">${r._weeksList}</td>
        </tr>`;
      }).join("");

      // NOTE per prossima settimana ‚Äî elenca TUTTI i pari-minimo / pari-massimo
      function humanList(names){
        if (names.length === 1) return names[0];
        if (names.length === 2) return `${names[0]} e ${names[1]}`;
        return `${names.slice(0,-1).join(", ")} e ${names.slice(-1)}`;
      }
      function adviceMulti(values, labels, what, weekend=false){
        const st = assessBalanceShares(values);
        if (st.balanced) return `${what}: distribuzione bilanciata ‚Äî nessuna azione specifica.`;
        const sum = values.reduce((a,b)=>a+b,0);
        const max = Math.max(...values), min = Math.min(...values);
        const maxGroup = labels.filter((_,i)=>values[i]===max);
        const minGroup = labels.filter((_,i)=>values[i]===min);
        if (weekend){
          return `${what}: avvantaggiare ${humanList(minGroup)} ‚Ä¢ svantaggiare ${humanList(maxGroup)}`;
        } else {
          return `${what}: pi√π a ${humanList(minGroup)} ‚Ä¢ meno a ${humanList(maxGroup)}`;
        }
      }

      const labels = dipendenti;
      const notes = [
        adviceMulti(perMetricValues["aperture"], labels, "Aperture"),
        adviceMulti(perMetricValues["chiusure"], labels, "Chiusure"),
        adviceMulti(perMetricValues["apertureWEFest"], labels, "Aperture nel weekend/festivi", true),
        adviceMulti(perMetricValues["chiusureWEFest"], labels, "Chiusure nel weekend/festivi", true),
        (function(){
          const vals = perMetricValues["_eventsN"];
          const st = assessBalanceShares(vals);
          if (st.balanced) return `Eventi "a casa": distribuzione bilanciata.`;
          const max = Math.max(...vals), min = Math.min(...vals);
          const maxGroup = labels.filter((_,i)=>vals[i]===max);
          const minGroup = labels.filter((_,i)=>vals[i]===min);
          return `Eventi "a casa": in eccesso ${humanList(maxGroup)} ‚Ä¢ in difetto ${humanList(minGroup)}`;
        })()
      ];

      document.getElementById("notesBody").innerHTML = notes.map(n => {
        const [title, ...rest] = n.split(": ");
        return `<tr><td><b>${title}</b></td><td>${rest.join(": ")}</td></tr>`;
      }).join("");

    })().catch(err=>{
      console.error(err);
      alert("Errore: " + err.message +
        "\n- Il documento resta pubblicato come pagina web (OK)." +
        "\n- Lettura via export CSV della stessa scheda.");
    });
  </script>
</body>
</html>

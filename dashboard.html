<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Statistiche Orari Profumeria</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root { --card:#fff; --bg:#f6f6f6; --muted:#666; }
    body { font-family: Arial, sans-serif; margin: 0; background: var(--bg); color:#111; }
    header { padding:20px 24px; background:#fff; box-shadow:0 1px 4px rgba(0,0,0,.06); position:sticky; top:0; z-index:10; }
    h1 { margin:0; font-size:20px; }
    .wrap { padding:20px 24px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(320px,1fr)); gap:16px; }
    .card { background: var(--card); border-radius:16px; padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.05);}
    .card h2 { margin:0 0 10px; font-size:16px; color:#222;}
    table { width:100%; border-collapse: collapse; font-size:14px; }
    th, td { border-bottom:1px solid #eee; padding:8px; text-align:center; }
    th { background:#fafafa; font-weight:600; }
    .muted { color: var(--muted); font-size:12px; }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ“Š Statistiche Orari Profumeria</h1>
    <div class="muted">Dati letti dal link pubhtml (senza CSV), scheda giÃ  pubblicata.</div>
  </header>

  <div class="wrap">
    <div class="grid">
      <div class="card">
        <h2>Riepilogo per dipendente</h2>
        <div id="riepilogo"></div>
      </div>
      <div class="card">
        <h2>Aperture per dipendente</h2>
        <canvas id="chartAperture" height="260"></canvas>
      </div>
      <div class="card">
        <h2>Chiusure per dipendente</h2>
        <canvas id="chartChiusure" height="260"></canvas>
      </div>
      <div class="card">
        <h2>Eventi complessivi</h2>
        <canvas id="chartEventi" height="260"></canvas>
      </div>
      <div class="card">
        <h2>Aperture la domenica (per dipendente)</h2>
        <div id="apertureDomenica"></div>
      </div>
    </div>
  </div>

  <script>
    // === TUO LINK PUBBLICATO (pubhtml) ===
    const PUBHTML = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTiGFO5sDWqthBzsCJ08wsG5bM4BjidbyZBwRXt32IuAkcr0BWhCmSTA-ZyayT07w/pubhtml?gid=876412715&single=true";

    // Fallback CORS (se la fetch diretta viene bloccata): usa un proxy read-only
    function corsFallback(url){
      // usa r.jina.ai per ottenere l'HTML con CORS abilitato
      return "https://r.jina.ai/http/" + url.replace(/^https?:\/\//, "");
    }

    async function fetchPubHtml(url){
      // 1Â° tentativo: fetch diretto
      try{
        const r = await fetch(url, {credentials:"omit", mode:"cors"});
        if (r.ok) return await r.text();
      }catch(e){}
      // fallback
      const proxied = corsFallback(url);
      const r2 = await fetch(proxied);
      if (!r2.ok) throw new Error("Impossibile leggere il pubhtml ("+r2.status+")");
      return await r2.text();
    }

    // Estrae la tabella principale dal pubhtml e restituisce array di righe (array di celle testo)
    function extractTable(html){
      const doc = new DOMParser().parseFromString(html, "text/html");
      // i fogli pubblicati usano tavole con classi tipo "waffle"
      const tables = Array.from(doc.querySelectorAll("table"));
      if (!tables.length) throw new Error("Nessuna tabella trovata nel pubhtml.");

      // Scegli la prima tabella che contiene un header con "Data" e almeno 2 nomi noti
      const guessNames = ["Ilenia","Cinzia","Michela","Vivien"];
      let target = null;
      for (const t of tables){
        const rows = Array.from(t.querySelectorAll("tr")).slice(0,10);
        for (const tr of rows){
          const cells = Array.from(tr.children).map(td => td.textContent.trim());
          const hasData = cells.some(c => /data/i.test(c));
          const foundNames = guessNames.filter(n => cells.some(c => c.toLowerCase() === n.toLowerCase()));
          if (hasData && foundNames.length >= 2){ target = t; break; }
        }
        if (target) break;
      }
      if (!target) target = tables[0];

      const out = [];
      const trs = Array.from(target.querySelectorAll("tr"));
      for (const tr of trs){
        const cells = Array.from(tr.children).map(td => td.textContent.trim());
        // ignora righe completamente vuote
        if (cells.every(c => c === "")) continue;
        out.push(cells);
      }
      return out;
    }

    // Trova l'indice della riga di header (quella che contiene "Data")
    function findHeaderRow(rows){
      for (let i=0;i<rows.length;i++){
        const r = rows[i];
        if (r.some(c => /data/i.test(c))) return i;
      }
      // fallback: prima riga
      return 0;
    }

    // parsing data dd/mm/yyyy â†’ Date
    function parseItaDate(dstr){
      if (!dstr) return null;
      if (/^\d{4}-\d{2}-\d{2}$/.test(dstr)) return new Date(dstr);
      const m = dstr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (!m) return new Date(dstr);
      return new Date(+m[3], +m[2]-1, +m[1]);
    }

    (async function main(){
      const html = await fetchPubHtml(PUBHTML);
      const matrix = extractTable(html);
      const headerRowIdx = findHeaderRow(matrix);
      const header = matrix[headerRowIdx].map(h => h.trim());
      const dataRows = matrix.slice(headerRowIdx+1);

      // Trova colonna "Data" e colonne dipendenti
      const idxData = header.findIndex(h => /data/i.test(h));
      if (idxData === -1) throw new Error("Colonna 'Data' non trovata nell'header.");
      const dipCols = header
        .map((h,i)=>({h,i}))
        .filter(o => /ilenia|cinzia|michela|vivien/i.test(o.h));
      const dipendenti = dipCols.map(o => o.h);

      // Statistiche (conteggi testuali)
      const stats = {};
      dipendenti.forEach(d => stats[d] = {
        apertura:0, chiusura:0,
        ferie:0, rec:0, riposo:0, "104":0, malattia:0,
        apertureDomenica:0, turniWeekend:0
      });

      for (const r of dataRows){
        if (!r[idxData]) continue;
        const dt = parseItaDate(r[idxData]);
        if (!dt || isNaN(+dt)) continue;
        const dow = dt.getDay(); // 0=dom, 6=sab
        const isWeekend = (dow===0 || dow===6);
        const isSunday = (dow===0);

        for (const {h,i} of dipCols){
          const raw = (r[i] || "").toString().trim().toLowerCase();
          if (!raw) continue;

          if (raw === "ferie") { stats[h].ferie++; continue; }
          if (raw === "rec") { stats[h].rec++; continue; }
          if (raw === "riposo") { stats[h].riposo++; continue; }
          if (raw === "104") { stats[h]["104"]++; continue; }
          if (raw === "malattia") { stats[h].malattia++; continue; }
          if (raw === "apertura") {
            stats[h].apertura++;
            if (isSunday) stats[h].apertureDomenica++;
          } else if (raw === "chiusura") {
            stats[h].chiusura++;
          }
          if (isWeekend && !["ferie","rec","riposo","104","malattia"].includes(raw)){
            stats[h].turniWeekend++;
          }
        }
      }

      // Riepilogo
      const el = document.getElementById("riepilogo");
      let htmlOut = `<table>
        <tr>
          <th>Dipendente</th>
          <th>Aperture</th>
          <th>Chiusure</th>
          <th>Aperture Domenica</th>
          <th>Ferie</th>
          <th>REC</th>
          <th>Riposo</th>
          <th>104</th>
          <th>Malattia</th>
          <th>Turni Weekend</th>
        </tr>`;
      for (const d of dipendenti){
        const s = stats[d];
        htmlOut += `<tr>
          <td>${d}</td>
          <td>${s.apertura}</td>
          <td>${s.chiusura}</td>
          <td>${s.apertureDomenica}</td>
          <td>${s.ferie}</td>
          <td>${s.rec}</td>
          <td>${s.riposo}</td>
          <td>${s["104"]}</td>
          <td>${s.malattia}</td>
          <td>${s.turniWeekend}</td>
        </tr>`;
      }
      htmlOut += `</table>`;
      el.innerHTML = htmlOut;

      // Grafici
      const labels = dipendenti;
      const apertureData = labels.map(d => stats[d].apertura);
      const chiusureData = labels.map(d => stats[d].chiusura);

      new Chart(document.getElementById("chartAperture"), {
        type: "bar",
        data: { labels, datasets: [{ label: "Aperture", data: apertureData }] },
        options: { responsive:true, maintainAspectRatio:false }
      });

      new Chart(document.getElementById("chartChiusure"), {
        type: "bar",
        data: { labels, datasets: [{ label: "Chiusure", data: chiusureData }] },
        options: { responsive:true, maintainAspectRatio:false }
      });

      const sum = (k) => dipendenti.reduce((acc,d)=>acc+stats[d][k],0);
      new Chart(document.getElementById("chartEventi"), {
        type: "pie",
        data: {
          labels: ["Ferie","REC","Riposi","Malattia","104","Aperture","Chiusure","Aperture Domenica"],
          datasets: [{
            data: [sum("ferie"), sum("rec"), sum("riposo"), sum("malattia"), sum("104"),
                   sum("apertura"), sum("chiusura"), sum("apertureDomenica")]
          }]
        },
        options: { responsive:true, maintainAspectRatio:false }
      });

      // Aperture Domenica
      const ad = document.getElementById("apertureDomenica");
      let list = `<table><tr><th>Dipendente</th><th>Aperture Domenica</th></tr>`;
      for (const d of dipendenti){
        list += `<tr><td>${d}</td><td>${stats[d].apertureDomenica}</td></tr>`;
      }
      list += `</table>`;
      ad.innerHTML = list;

    })().catch(err=>{
      console.error(err);
      alert("Errore nel caricamento/parse del pubhtml:\n" + err.message +
        "\n- Il link Ã¨ quello pubblicato (ok). " +
        "\n- Questo script legge l'HTML pubblicato e ne estrae la tabella, senza CSV." +
        "\n- Se hai rinominato le colonne, assicurati che esistano 'Data' e i nomi Ilenia/Cinzia/Michela/Vivien.");
    });
  </script>
</body>
</html>

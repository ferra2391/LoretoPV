<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Statistiche Orari Profumeria</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root { --card:#fff; --bg:#f6f6f6; --muted:#6b7280; --border:#e5e7eb; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:var(--bg); color:#111; }
    header { padding:18px 22px; background:#fff; box-shadow:0 1px 6px rgba(0,0,0,.06); position:sticky; top:0; z-index:10; }
    h1 { margin:0; font-size:18px; }
    .muted { color:var(--muted); font-size:12px; }
    .wrap { padding:18px 22px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:0 2px 10px rgba(0,0,0,.04); }
    .card h2 { margin:0 0 10px; font-size:15px; color:#222; }
    .table-wrap { max-height:75vh; overflow:auto; border:1px solid var(--border); border-radius:10px; }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    thead th { position:sticky; top:0; background:#fff; z-index:1; border-bottom:1px solid var(--border); }
    th, td { padding:10px 8px; text-align:center; border-bottom:1px solid var(--border); }
    tbody tr:nth-child(even){ background:#fafafa; }
    tbody tr:hover { background:#f3f4f6; }
    td:first-child, th:first-child { text-align:left; }
  </style>
</head>
<body>
  <header>
    <h1>üìä Statistiche Orari Profumeria</h1>
    <div class="muted">Dati dal tuo link pubblicato (CSV dell‚ÄôURL pubhtml, nessuna modifica alla condivisione).</div>
  </header>

  <div class="wrap">
    <div class="card">
      <h2>Riepilogo per dipendente</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Dipendente</th>
              <th>Aperture</th>
              <th>Chiusure</th>
              <th>Aperture Weekend/Festivi</th>
              <th>Chiusure Weekend/Festivi</th>
              <th>Ferie</th>
              <th>Riposo</th>
              <th>104</th>
              <th>Malattia</th>
              <th>Eventi ‚Äúa casa‚Äù (n)</th>
              <th>Eventi ‚Äúa casa‚Äù (%)</th>
              <th>Settimane (ISO) eventi</th>
            </tr>
          </thead>
          <tbody id="riepilogo"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Tuo link pubhtml con gid fisso
    const PUBHTML = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTiGFO5sDWqthBzsCJ08wsG5bM4BjidbyZBwRXt32IuAkcr0BWhCmSTA-ZyayT07w/pubhtml?gid=876412715&single=true";

    function getPubInfo(pubhtml){
      const idm = pubhtml.match(/\/d\/e\/([^/]+)\/pubhtml/);
      if(!idm) throw new Error("PUB_ID non riconosciuto nel link.");
      const gidm = pubhtml.match(/[?&]gid=(\d+)/);
      return { pubId: idm[1], gid: gidm ? gidm[1] : "0" };
    }

    async function fetchCSV(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error(`Fetch failed ${r.status}`);
      const text = await r.text();
      const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
      if (parsed.errors.length) console.warn("PapaParse errors:", parsed.errors);
      return parsed.data;
    }

    // Util date
    function parseItaDate(dstr){
      if (!dstr) return null;
      if (/^\d{4}-\d{2}-\d{2}$/.test(dstr)) return new Date(dstr);
      const m = dstr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (!m) return new Date(dstr);
      return new Date(+m[3], +m[2]-1, +m[1]);
    }
    function toYMD(d){ return d.toISOString().slice(0,10); }
    function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

    // ISO week number + ISO week year
    function isoWeek(date){
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const day = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - day);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }
    function isoWeekYear(date){
      const d = new Date(date.getTime());
      d.setDate(d.getDate() + 4 - (d.getDay() || 7));
      return d.getFullYear();
    }

    // Festivit√† italiane (fisse + Pasqua/Pasquetta)
    function easterSunday(year){
      const a = year % 19, b = Math.floor(year/100), c = year % 100;
      const d = Math.floor(b/4), e = b % 4, f = Math.floor((b+8)/25);
      const g = Math.floor((b - f + 1)/3), h = (19*a + b - d - g + 15) % 30;
      const i = Math.floor(c/4), k = c % 4, l = (32 + 2*e + 2*i - h - k) % 7;
      const m = Math.floor((a + 11*h + 22*l)/451);
      const month = Math.floor((h + l - 7*m + 114)/31), day = ((h + l - 7*m + 114) % 31) + 1;
      return new Date(year, month-1, day);
    }
    function italianHolidays(year){
      const set = new Set();
      const add = (m,d)=> set.add(toYMD(new Date(year, m-1, d)));
      add(1,1); add(1,6); add(4,25); add(5,1); add(6,2);
      add(8,15); add(11,1); add(12,8); add(12,25); add(12,26);
      const easter = easterSunday(year), pasquetta = addDays(easter,1);
      set.add(toYMD(easter)); set.add(toYMD(pasquetta));
      return set;
    }
    function isHoliday(date, holidaysMap){
      const y = date.getFullYear();
      if(!holidaysMap.has(y)) holidaysMap.set(y, italianHolidays(y));
      return holidaysMap.get(y).has(toYMD(date));
    }

    (async function main(){
      const { pubId, gid } = getPubInfo(PUBHTML);

      // Export CSV del documento pubblicato (fallback gviz se serve)
      let csvUrl = `https://docs.google.com/spreadsheets/d/e/${pubId}/pub?gid=${gid}&single=true&output=csv`;
      let rows;
      try {
        rows = await fetchCSV(csvUrl);
      } catch (e1) {
        csvUrl = `https://docs.google.com/spreadsheets/d/e/${pubId}/gviz/tq?gid=${gid}&tqx=out:csv`;
        rows = await fetchCSV(csvUrl);
      }

      // Colonne attese: Settimana | Data | Ilenia | Cinzia | Michela | Vivien (valori testuali)
      const headerKeys = rows.length ? Object.keys(rows[0]) : [];
      const colData = headerKeys.find(k => k.toLowerCase().includes("data"));
      if (!colData) throw new Error("Colonna 'Data' non trovata.");
      const dipCols = headerKeys.filter(k => /ilenia|cinzia|michela|vivien/i.test(k));
      const dipendenti = dipCols.slice();

      // Indice per data
      const byDate = new Map(); // YYYY-MM-DD -> { colName: valueLower }
      const holidaysMap = new Map();

      // Statistiche
      const stats = {};
      dipendenti.forEach(d => stats[d] = {
        aperture:0, chiusure:0,
        apertureWEFest:0, chiusureWEFest:0,
        ferie:0, riposo:0, "104":0, malattia:0,
        eventsWeeksAll: new Set() // chiave "YYYY-W##" delle settimane evento
      });

      // Conteggi base + indicizzazione per data
      for (const row of rows){
        const dt = parseItaDate(row[colData]);
        if (!dt || isNaN(+dt)) continue;
        const ymd = toYMD(dt);
        const dow = dt.getDay(); // 0=dom,6=sab
        const weekend = (dow===0 || dow===6);
        const festivo = isHoliday(dt, holidaysMap);
        if (!byDate.has(ymd)) byDate.set(ymd, {});
        const dayObj = byDate.get(ymd);

        for (const col of dipCols){
          const raw = (row[col] || "").toString().trim().toLowerCase();
          dayObj[col] = raw;

          if (!raw) continue;
          if (raw === "apertura") {
            stats[col].aperture++;
            if (weekend || festivo) stats[col].apertureWEFest++;
          } else if (raw === "chiusura") {
            stats[col].chiusure++;
            if (weekend || festivo) stats[col].chiusureWEFest++;
          } else if (raw === "ferie") {
            stats[col].ferie++;
          } else if (raw === "riposo") {
            stats[col].riposo++;
          } else if (raw === "104") {
            stats[col]["104"]++;
          } else if (raw === "malattia") {
            stats[col].malattia++;
          }
        }
      }

      // Helper ‚Äúa casa‚Äù (include MALATTIA)
      const isHome = (val) => ["ferie","riposo","104","malattia"].includes((val||"").toString().toLowerCase());

      // Analisi eventi per settimane ISO (considero la DOMENICA come ancoraggio della settimana)
      const allDates = Array.from(byDate.keys()).sort();
      const get = (ymd,col) => ((byDate.get(ymd)||{})[col]) || "";
      function keyYearWeek(date){ return `${isoWeekYear(date)}-W${String(isoWeek(date)).padStart(2,"0")}`; }

      for (const ymd of allDates){
        const d = new Date(ymd);
        if (d.getDay() !== 0) continue; // processa solo le domeniche
        const sun = d, sat = addDays(sun,-1), fri = addDays(sun,-2), mon = addDays(sun,1);
        const friHoliday = isHoliday(fri, holidaysMap);
        const monHoliday = isHoliday(mon, holidaysMap);
        const weekKey = keyYearWeek(sun);

        for (const col of dipCols){
          const satHome = isHome(get(toYMD(sat), col));
          const sunHome = isHome(get(toYMD(sun), col));
          const cond1 = satHome && sunHome;            // Sab + Dom a casa
          const cond2 = sunHome && monHoliday;         // Dom a casa + lun festivo
          const cond3 = friHoliday && satHome && sunHome; // Ven festivo + Sab + Dom a casa
          if (cond1 || cond2 || cond3){
            stats[col].eventsWeeksAll.add(weekKey);
          }
        }
      }

      // Calcolo %: (eventi fino alla settimana ISO odierna) / (settimana ISO odierna)
      const today = new Date();
      const currentIsoWeek = isoWeek(today);
      const currentIsoYear = isoWeekYear(today);

      const body = document.getElementById("riepilogo");
      body.innerHTML = dipendenti.map(d => {
        const s = stats[d];

        // settimane evento dell'anno ISO corrente (solo fino alla settimana attuale)
        const weeksThisYearUpToNow = Array
          .from(s.eventsWeeksAll)
          .map(k => {
            const [y, w] = k.split("-W").map(Number);
            return { y, w };
          })
          .filter(o => o.y === currentIsoYear && o.w <= currentIsoWeek)
          .sort((a,b)=>a.w-b.w);

        const nEvents = weeksThisYearUpToNow.length;
        const perc = currentIsoWeek > 0 ? (nEvents / currentIsoWeek) * 100 : 0;
        const weeksList = weeksThisYearUpToNow.map(o => o.w).join(", ");

        return `<tr>
          <td>${d}</td>
          <td>${s.aperture}</td>
          <td>${s.chiusure}</td>
          <td>${s.apertureWEFest}</td>
          <td>${s.chiusureWEFest}</td>
          <td>${s.ferie}</td>
          <td>${s.riposo}</td>
          <td>${s["104"]}</td>
          <td>${s.malattia}</td>
          <td>${nEvents}</td>
          <td>${perc.toFixed(1)}%</td>
          <td>${weeksList}</td>
        </tr>`;
      }).join("");

    })().catch(err=>{
      console.error(err);
      alert("Errore: " + err.message +
        "\n- Il documento resta pubblicato come pagina web (OK)." +
        "\n- Sto leggendo l‚Äôexport CSV della stessa scheda per calcolare le statistiche.");
    });
  </script>
</body>
</html>

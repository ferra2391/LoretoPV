<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Statistiche Orari Profumeria</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root {
      --bg:#f6f7fb; --card:#ffffff; --border:#e6e8f0; --muted:#6b7280; --ink:#0f172a;
      --head:#0b1220; --accent:#1f6feb;
    }
    * { box-sizing: border-box; }
    html, body { height:100%; }
    body {
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg); color:var(--ink); line-height:1.4;
    }
    header {
      position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid var(--border);
    }
    .wrap { max-width:1200px; margin:0 auto; padding:18px 20px; }
    h1 { margin:0; font-size:22px; color:var(--head); }
    .sub { color:var(--muted); font-size:13px; margin-top:6px; }

    .badges { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .badge {
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--border);
      background:var(--card); border-radius:999px; font-size:12px; color:#0f172a;
    }

    main.wrap { display:grid; grid-template-columns: 1fr 360px; gap:18px; }
    @media (max-width: 980px){ main.wrap { grid-template-columns: 1fr; } }

    .card {
      background:var(--card); border:1px solid var(--border); border-radius:16px;
      box-shadow: 0 1px 6px rgba(0,0,0,.04);
    }
    .card-header { padding:14px 16px; border-bottom:1px solid var(--border); }
    .card-title { margin:0; font-size:16px; color:var(--head); }
    .card-body { padding:12px 16px; }

    .legend { font-size:14px; color:#111; }
    .legend h3 { margin:0 0 10px; font-size:15px; color:var(--head); }
    .legend ul { margin:6px 0 12px 18px; padding:0; }
    .legend li { margin:6px 0; }
    .legend .muted { color:var(--muted); font-size:12px; }

    .table-wrap {
      border:1px solid var(--border); border-radius:12px; overflow:auto; max-height:70vh; background:#fff;
    }
    table { width:100%; border-collapse:separate; border-spacing:0; font-size:15px; }
    thead th {
      position:sticky; top:0; background:#fff; z-index:1; color:#0b1220;
      border-bottom:1px solid var(--border); font-weight:700; padding:12px 10px;
    }
    tbody td { padding:12px 10px; border-bottom:1px solid var(--border); }
    tbody tr:nth-child(even){ background:#fafafa; }
    tbody tr:hover { background:#f1f5f9; }
    th:first-child, td:first-child { text-align:left; width:180px; }
    .num { text-align:right; font-variant-numeric: tabular-nums; }
    .weeks { text-align:left; white-space:normal; max-width:280px; }

    .footnote { margin-top:10px; color:var(--muted); font-size:12px; }
    .controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
    .btn {
      border:1px solid var(--border); background:#fff; padding:6px 10px; border-radius:10px; cursor:pointer; font-size:13px;
    }
    .btn:hover { border-color:#cfd3e1; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>üìä Statistiche Orari Profumeria</h1>
      <div class="sub">Dati dal foglio Google pubblicato (lettura automatica, nessuna modifica alla condivisione).</div>
      <div class="badges">
        <div class="badge" id="isoBadge">Settimana ISO: ‚Ä¶</div>
        <div class="badge" id="updBadge">Aggiornato: ‚Ä¶</div>
      </div>
    </div>
  </header>

  <main class="wrap" aria-live="polite">
    <!-- TABELLONE -->
    <section class="card" aria-label="Riepilogo per dipendente">
      <div class="card-header"><h2 class="card-title">Riepilogo per dipendente</h2></div>
      <div class="card-body">
        <div class="controls">
          <button class="btn" id="fontMinus" title="Riduci dimensione tabella">A‚àí</button>
          <button class="btn" id="fontPlus" title="Aumenta dimensione tabella">A+</button>
        </div>
        <div class="table-wrap">
          <table aria-describedby="legend">
            <thead>
              <tr>
                <th>Dipendente</th>
                <th class="num">Aperture</th>
                <th class="num">Chiusure</th>
                <th class="num">Aperture WE/Festivi</th>
                <th class="num">Chiusure WE/Festivi</th>
                <th class="num">Ferie</th>
                <th class="num">Riposo</th>
                <th class="num">104</th>
                <th class="num">Malattia</th>
                <th class="num">Eventi ‚Äúa casa‚Äù (n)</th>
                <th class="num">Eventi ‚Äúa casa‚Äù (%)</th>
                <th class="weeks">Settimane (ISO) eventi</th>
              </tr>
            </thead>
            <tbody id="riepilogo"></tbody>
          </table>
        </div>
        <div class="footnote">
          Tip: scorri orizzontalmente se vedi la tabella tagliata sullo schermo piccolo.
        </div>
      </div>
    </section>

    <!-- LEGENDA -->
    <aside class="card" id="legend">
      <div class="card-header"><h2 class="card-title">Legenda & criteri di calcolo</h2></div>
      <div class="card-body legend">
        <h3>Eventi ‚Äúa casa‚Äù</h3>
        <ul>
          <li><b>Cosa conta come ‚Äúa casa‚Äù:</b> <code>FERIE</code>, <code>RIPOSO</code>, <code>104</code>, <code>MALATTIA</code>.</li>
          <li><b>Quando scatta un evento (per settimana ISO):</b>
            <ul>
              <li><b>Sabato + Domenica</b> entrambi ‚Äúa casa‚Äù.</li>
              <li><b>Domenica</b> ‚Äúa casa‚Äù + <b>luned√¨ successivo festivo</b>.</li>
              <li><b>Venerd√¨ festivo</b> + <b>Sabato</b> ‚Äúa casa‚Äù + <b>Domenica</b> ‚Äúa casa‚Äù.</li>
            </ul>
          </li>
          <li>Elenco ‚ÄúSettimane (ISO) eventi‚Äù: sono i numeri di settimana in cui la condizione √® stata soddisfatta
              (riferite all‚Äô<b>anno ISO corrente</b> per la %).</li>
        </ul>

        <h3>Percentuale ‚Äúeventi a casa‚Äù</h3>
        <ul>
          <li><b>Formula:</b> (Eventi ‚Äúa casa‚Äù <u>fino alla settimana ISO odierna</u>) / (Numero della settimana ISO odierna) √ó 100.</li>
          <li><b>Settimana ISO:</b> lun‚Äìdom; la settimana 01 √® quella che contiene il 4 gennaio.</li>
        </ul>

        <h3>Weekend & Festivi</h3>
        <ul>
          <li><b>Weekend:</b> sabato e domenica.</li>
          <li><b>Festivi considerati:</b> 1/1, 6/1, Pasqua (dom), Luned√¨ dell‚ÄôAngelo, 25/4, 1/5, 2/6, 15/8, 1/11, 8/12, 25/12, 26/12.</li>
        </ul>

        <p class="muted">Nota: se i dati contengono pi√π anni, la % usa <b>solo</b> le settimane dell‚Äôanno ISO corrente; possiamo aggiungere filtri per anno/mese su richiesta.</p>
      </div>
    </aside>
  </main>

  <script>
    // ‚Äî‚Äî‚Äî CONFIG: tuo link pubhtml (immutato) ‚Äî‚Äî‚Äî
    const PUBHTML = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTiGFO5sDWqthBzsCJ08wsG5bM4BjidbyZBwRXt32IuAkcr0BWhCmSTA-ZyayT07w/pubhtml?gid=876412715&single=true";

    function getPubInfo(pubhtml){
      const idm = pubhtml.match(/\/d\/e\/([^/]+)\/pubhtml/);
      if(!idm) throw new Error("PUB_ID non riconosciuto nel link.");
      const gidm = pubhtml.match(/[?&]gid=(\d+)/);
      return { pubId: idm[1], gid: gidm ? gidm[1] : "0" };
    }

    async function fetchCSV(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error(`Fetch failed ${r.status}`);
      const text = await r.text();
      const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
      if (parsed.errors.length) console.warn("PapaParse errors:", parsed.errors);
      return parsed.data;
    }

    // Date utils
    function parseItaDate(dstr){
      if (!dstr) return null;
      if (/^\d{4}-\d{2}-\d{2}$/.test(dstr)) return new Date(dstr);
      const m = dstr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (!m) return new Date(dstr);
      return new Date(+m[3], +m[2]-1, +m[1]);
    }
    function toYMD(d){ return d.toISOString().slice(0,10); }
    function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

    // ISO week number + ISO week year
    function isoWeek(date){
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const day = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - day);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }
    function isoWeekYear(date){
      const d = new Date(date.getTime());
      d.setDate(d.getDate() + 4 - (d.getDay() || 7));
      return d.getFullYear();
    }

    // Pasqua + festivi Italia
    function easterSunday(year){
      const a=year%19, b=Math.floor(year/100), c=year%100, d=Math.floor(b/4), e=b%4;
      const f=Math.floor((b+8)/25), g=Math.floor((b-f+1)/3);
      const h=(19*a+b-d-g+15)%30, i=Math.floor(c/4), k=c%4;
      const l=(32+2*e+2*i-h-k)%7, m=Math.floor((a+11*h+22*l)/451);
      const month=Math.floor((h+l-7*m+114)/31), day=((h+l-7*m+114)%31)+1;
      return new Date(year, month-1, day);
    }
    function italianHolidays(year){
      const set=new Set(); const add=(m,d)=>set.add(toYMD(new Date(year,m-1,d)));
      add(1,1); add(1,6); add(4,25); add(5,1); add(6,2); add(8,15); add(11,1); add(12,8); add(12,25); add(12,26);
      const easter=easterSunday(year), pasquetta=addDays(easter,1);
      set.add(toYMD(easter)); set.add(toYMD(pasquetta));
      return set;
    }
    function isHoliday(date, holidaysMap){
      const y=date.getFullYear();
      if(!holidaysMap.has(y)) holidaysMap.set(y, italianHolidays(y));
      return holidaysMap.get(y).has(toYMD(date));
    }

    // UI helpers: font size controls
    (function fontControls(){
      const tbl = document.querySelector("table");
      const plus = document.getElementById("fontPlus");
      const minus = document.getElementById("fontMinus");
      let size = 15;
      function apply(){ tbl.style.fontSize = size + "px"; }
      plus.onclick = ()=>{ size = Math.min(18, size+1); apply(); };
      minus.onclick = ()=>{ size = Math.max(12, size-1); apply(); };
      apply();
    })();

    (async function main(){
      // Badges
      const now = new Date();
      document.getElementById("isoBadge").textContent = `Settimana ISO: ${isoWeek(now)}/${isoWeekYear(now)}`;
      document.getElementById("updBadge").textContent = `Aggiornato: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;

      const { pubId, gid } = getPubInfo(PUBHTML);
      // CSV export (fallback gviz CSV)
      let csvUrl = `https://docs.google.com/spreadsheets/d/e/${pubId}/pub?gid=${gid}&single=true&output=csv`;
      let rows;
      try { rows = await fetchCSV(csvUrl); }
      catch(e1){ csvUrl = `https://docs.google.com/spreadsheets/d/e/${pubId}/gviz/tq?gid=${gid}&tqx=out:csv`; rows = await fetchCSV(csvUrl); }

      const headerKeys = rows.length ? Object.keys(rows[0]) : [];
      const colData = headerKeys.find(k => k.toLowerCase().includes("data"));
      if (!colData) throw new Error("Colonna 'Data' non trovata.");
      const dipCols = headerKeys.filter(k => /ilenia|cinzia|michela|vivien/i.test(k));
      const dipendenti = dipCols.slice();

      // Indice per data
      const byDate = new Map(); // YYYY-MM-DD -> { col: valueLower }
      const holidaysMap = new Map();

      // Stat
      const stats = {};
      dipendenti.forEach(d => stats[d] = {
        aperture:0, chiusure:0,
        apertureWEFest:0, chiusureWEFest:0,
        ferie:0, riposo:0, "104":0, malattia:0,
        eventsWeeksAll: new Set()
      });

      // Conteggi base + indice
      for (const row of rows){
        const dt = parseItaDate(row[colData]);
        if (!dt || isNaN(+dt)) continue;
        const ymd = toYMD(dt);
        const dow = dt.getDay(); // 0=dom,6=sab
        const weekend = (dow===0 || dow===6);
        const festivo = isHoliday(dt, holidaysMap);
        if (!byDate.has(ymd)) byDate.set(ymd, {});
        const dayObj = byDate.get(ymd);

        for (const col of dipCols){
          const raw = (row[col] || "").toString().trim().toLowerCase();
          dayObj[col] = raw;

          if (!raw) continue;
          if (raw === "apertura") {
            stats[col].aperture++;
            if (weekend || festivo) stats[col].apertureWEFest++;
          } else if (raw === "chiusura") {
            stats[col].chiusure++;
            if (weekend || festivo) stats[col].chiusureWEFest++;
          } else if (raw === "ferie") {
            stats[col].ferie++;
          } else if (raw === "riposo") {
            stats[col].riposo++;
          } else if (raw === "104") {
            stats[col]["104"]++;
          } else if (raw === "malattia") {
            stats[col].malattia++;
          }
        }
      }

      // Helper ‚Äúa casa‚Äù
      const isHome = (val) => ["ferie","riposo","104","malattia"].includes((val||"").toString().toLowerCase());
      const allDates = Array.from(byDate.keys()).sort();
      const get = (ymd,col) => ((byDate.get(ymd)||{})[col]) || "";

      function weekKey(date){
        return `${isoWeekYear(date)}-W${String(isoWeek(date)).padStart(2,"0")}`;
      }

      // Eventi per settimana (ancorati alla domenica)
      for (const ymd of allDates){
        const d = new Date(ymd);
        if (d.getDay() !== 0) continue; // solo domeniche
        const sun = d, sat = addDays(sun,-1), fri = addDays(sun,-2), mon = addDays(sun,1);
        const friHoliday = isHoliday(fri, holidaysMap);
        const monHoliday = isHoliday(mon, holidaysMap);
        const wKey = weekKey(sun);

        for (const col of dipCols){
          const satHome = isHome(get(toYMD(sat), col));
          const sunHome = isHome(get(toYMD(sun), col));
          const cond1 = satHome && sunHome;
          const cond2 = sunHome && monHoliday;
          const cond3 = friHoliday && satHome && sunHome;
          if (cond1 || cond2 || cond3){
            stats[col].eventsWeeksAll.add(wKey);
          }
        }
      }

      // Render tabella
      const today = new Date();
      const curW = isoWeek(today), curY = isoWeekYear(today);

      const tbody = document.getElementById("riepilogo");
      tbody.innerHTML = dipendenti.map(d => {
        const s = stats[d];

        // settimane evento per l'anno corrente e fino alla settimana odierna
        const weeksThisYearUpToNow = Array.from(s.eventsWeeksAll)
          .map(k => { const [yPart,wPart] = k.split("-W"); return { y:+yPart, w:+wPart }; })
          .filter(o => o.y === curY && o.w <= curW)
          .sort((a,b)=>a.w-b.w);

        const nEvents = weeksThisYearUpToNow.length;
        const perc = curW > 0 ? (nEvents / curW) * 100 : 0;
        const weeksList = weeksThisYearUpToNow.map(o => o.w).join(", ");

        return `<tr>
          <td>${d}</td>
          <td class="num">${s.aperture}</td>
          <td class="num">${s.chiusure}</td>
          <td class="num">${s.apertureWEFest}</td>
          <td class="num">${s.chiusureWEFest}</td>
          <td class="num">${s.ferie}</td>
          <td class="num">${s.riposo}</td>
          <td class="num">${s["104"]}</td>
          <td class="num">${s.malattia}</td>
          <td class="num">${nEvents}</td>
          <td class="num">${perc.toFixed(1)}%</td>
          <td class="weeks">${weeksList || "‚Äî"}</td>
        </tr>`;
      }).join("");

    })().catch(err=>{
      console.error(err);
      alert("Errore: " + err.message +
        "\n- Il documento resta pubblicato come pagina web (OK)." +
        "\n- Lettura via export CSV della stessa scheda.");
    });
  </script>
</body>
</html>

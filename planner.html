<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<title>Planner Orari ‚Äì Settimana Successiva</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --border:#e6e8f0; --muted:#6b7280; --ink:#0f172a;
    --open:#dff7df; --mid:#fff7d6; --close:#e5f0ff; --rest:#f3f4f6; --rec:#ffe7ec;
    --danger:#dc2626; --accent:#0ea5e9;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:0 auto;padding:18px 20px}
  header .wrap{display:flex;flex-direction:column;align-items:center;text-align:center}
  h1{margin:0;font-size:22px}
  .badges{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px}
  .badge{display:inline-flex;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--card);font-size:12px}
  main.wrap{display:flex;flex-direction:column;gap:18px}

  .card{background:var(--card);border:1px solid var(--border);border-radius:16px}
  .card-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .card-title{margin:0;font-size:16px}
  .controls{display:flex;align-items:center;gap:12px;font-size:14px}
  .pill{display:inline-block;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer}

  .grid-wrap{border:1px solid var(--border);border-radius:12px;overflow:auto;background:#fff}
  table{width:100%;border-collapse:separate;border-spacing:0;min-width:980px;font-size:15px}
  thead th{position:sticky;top:0;background:#fff;z-index:2;border-bottom:1px solid var(--border);padding:10px 8px;white-space:nowrap}
  tbody td{padding:10px 8px;border-bottom:1px solid var(--border)}
  th:first-child,td:first-child{position:sticky;left:0;background:#fff;z-index:3}
  th:first-child,td:first-child{text-align:left;width:220px}

  .open{background:var(--open)}
  .mid{background:var(--mid)}
  .close{background:var(--close)}
  .rest{background:var(--rest);color:#374151}
  .rec{background:var(--rec)}

  .mini{font-size:12px;color:#374151}
  .right{float:right;color:#6b7280}
  .muted{color:#6b7280}
  .ring{display:inline-flex;align-items:center;justify-content:center;min-width:2.2ch;padding:0 6px;border:2px solid var(--danger);border-radius:999px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>üóìÔ∏è Planner Orari ‚Äì Settimana Successiva</h1>
    <div class="badges">
      <div class="badge" id="badgeWeek">Settimana: ‚Äî</div>
      <div class="badge" id="badgeRange">Periodo: ‚Äî</div>
      <div class="badge" id="badgeUpdated">Aggiornato: ‚Äî</div>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <div class="card-header">
      <h2 class="card-title">Proposta turni (blocchi da 4h, copertura 9‚Äì20)</h2>
      <div class="controls">
        Intensit√† correzione:
        <select id="intensity">
          <option value="1" selected>Soft (+1/-1)</option>
          <option value="2">Media (+2/-2)</option>
          <option value="3">Forte (+3/-3)</option>
        </select>
        Compresenze / giorno:
        <select id="compSlots">
          <option value="0">0</option>
          <option value="1" selected>1</option>
          <option value="2">2</option>
          <option value="3">3</option>
        </select>
        <button id="regen" class="pill">Rigenera</button>
      </div>
    </div>

    <div class="grid-wrap">
      <table id="planTable">
        <thead>
          <tr>
            <th>Dipendente</th>
            <th id="d0">Luned√¨</th><th id="d1">Marted√¨</th><th id="d2">Mercoled√¨</th>
            <th id="d3">Gioved√¨</th><th id="d4">Venerd√¨</th><th id="d5">Sabato</th><th id="d6">Domenica</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="wrap mini" style="padding:10px 16px 14px">
      Schema turni possibili (4h ciascuno): <b>9‚Äì13</b> (apertura), <b>12‚Äì16</b> (supporto 1), <b>13‚Äì17</b> (supporto 2), <b>16‚Äì20</b> (chiusura).
      <span class="right">Ogni persona max <b>1 turno/giorno</b>. Domenica lavorata ‚áí un <b>REC</b> in settimana.</span>
    </div>
  </section>

  <section class="card">
    <div class="card-header">
      <h2 class="card-title">Ore assegnate vs contratto (settimana proposta)</h2>
    </div>
    <div class="grid-wrap">
      <table id="hoursTable">
        <thead><tr><th>Dipendente</th><th>Ore assegnate</th><th>Contratto</th><th>Delta</th></tr></thead>
        <tbody id="hoursBody"></tbody>
      </table>
    </div>
    <div class="wrap muted" style="padding:10px 16px 14px">
      Se vuoi avvicinarti di pi√π ai monte ore contrattuali aumenta le <b>compresenze/giorno</b>.
    </div>
  </section>
</main>

<script>
// === CONFIG ===
const PUBHTML = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTiGFO5sDWqthBzsCJ08wsG5bM4BjidbyZBwRXt32IuAkcr0BWhCmSTA-ZyayT07w/pubhtml?gid=876412715&single=true";

// Monte ore settimanali (modificabili)
const CONTRACT_HOURS = { Ilenia:30, Cinzia:35, Michela:32, Vivien:40 };

// Turni 4h
const SHIFTS = [
  { key:"O", label:"9‚Äì13", css:"open"  },
  { key:"M1",label:"12‚Äì16", css:"mid"   },
  { key:"M2",label:"13‚Äì17", css:"mid"   },
  { key:"C", label:"16‚Äì20", css:"close" },
];

// === Utils date/ISO ===
function toYMD(d){ return d.toISOString().slice(0,10); }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function mondayOfNextWeek(base){ const b=new Date(base); const day=b.getDay()||7; const monday=addDays(b,1-day); return addDays(monday,7); }
function isoWeek(date){ const d=new Date(Date.UTC(date.getFullYear(),date.getMonth(),date.getDate())); const day=d.getUTCDay()||7; d.setUTCDate(d.getUTCDate()+4-day); const y0=new Date(Date.UTC(d.getUTCFullYear(),0,1)); return Math.ceil((((d-y0)/86400000)+1)/7); }
function isoWeekYear(date){ const d=new Date(date.getTime()); d.setDate(d.getDate()+4-(d.getDay()||7)); return d.getFullYear(); }
function parseItaDate(s){ if(!s) return null; if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s); const m=s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/); if(!m) return new Date(s); return new Date(+m[3],+m[2]-1,+m[1]); }

// Festivi IT
function easterSunday(y){const a=y%19,b=Math.floor(y/100),c=y%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451);const month=Math.floor((h+l-7*m+114)/31),day=((h+l-7*m+114)%31)+1;return new Date(y,month-1,day);}
function italianHolidays(year){const set=new Set(); const add=(m,d)=>set.add(toYMD(new Date(year,m-1,d))); add(1,1);add(1,6);add(4,25);add(5,1);add(6,2);add(8,15);add(11,1);add(12,8);add(12,25);add(12,26); const e=easterSunday(year), p=addDays(e,1); set.add(toYMD(e)); set.add(toYMD(p)); return set;}
const holidaysMap=new Map();
function isHoliday(date){ const y=date.getFullYear(); if(!holidaysMap.has(y)) holidaysMap.set(y,italianHolidays(y)); return holidaysMap.get(y).has(toYMD(date)); }

// === CSV fetch ===
function getPubInfo(pubhtml){ const idm=pubhtml.match(/\/d\/e\/([^/]+)\/pubhtml/); const gidm=pubhtml.match(/[?&]gid=(\d+)/); return {pubId:idm[1], gid: gidm?gidm[1]:"0"}; }
async function fetchCSV(url){ const r=await fetch(url); if(!r.ok) throw new Error(`Fetch failed ${r.status}`); const t=await r.text(); return Papa.parse(t,{header:true,skipEmptyLines:true}).data; }

// === Statistiche storiche ===
function assessBalanceShares(values){
  const sum=values.reduce((a,b)=>a+b,0); if(sum<=0) return {balanced:true, hi:[], lo:[], shares:values.map(_=>0)};
  const shares=values.map(v=>v/sum); const max=Math.max(...shares), min=Math.min(...shares);
  const balanced=(max-min)<=0.05;
  const hi=shares.map((s,i)=>s===max?i:null).filter(i=>i!==null);
  const lo=shares.map((s,i)=>s===min?i:null).filter(i=>i!==null);
  return {balanced, hi, lo, shares};
}

(async function main(){
  const now=new Date();
  document.getElementById("badgeUpdated").textContent="Aggiornato: "+now.toLocaleDateString('it-IT')+" "+now.toLocaleTimeString('it-IT');

  const {pubId,gid}=getPubInfo(PUBHTML);
  let csv=`https://docs.google.com/spreadsheets/d/e/${pubId}/pub?gid=${gid}&single=true&output=csv`;
  let rows; try{ rows=await fetchCSV(csv);}catch{ csv=`https://docs.google.com/spreadsheets/d/e/${pubId}/gviz/tq?gid=${gid}&tqx=out:csv`; rows=await fetchCSV(csv); }

  const headers=rows.length?Object.keys(rows[0]):[];
  const colData=headers.find(k=>k.toLowerCase().includes("data"));
  const dipCols=headers.filter(k=>/ilenia|cinzia|michela|vivien/i.test(k));
  const dips=dipCols.slice();

  // range e set settimane
  let minDate=null,maxDate=null;
  const weeksSet=new Set();

  // conteggi storici
  const stats={}; dips.forEach(d=>stats[d]={ap:0,ch:0,apWE:0,chWE:0});
  for(const r of rows){
    const dt=parseItaDate(r[colData]); if(!dt||isNaN(+dt)) continue;
    if(!minDate||dt<minDate) minDate=dt; if(!maxDate||dt>maxDate) maxDate=dt;
    weeksSet.add(`${isoWeekYear(dt)}-W${String(isoWeek(dt)).padStart(2,'0')}`);
    const dow=dt.getDay(); const we=(dow===0||dow===6)||isHoliday(dt);
    for(const d of dips){
      const v=(r[d]||"").toString().trim().toLowerCase();
      if(v==="apertura"){ stats[d].ap++; if(we) stats[d].apWE++; }
      else if(v==="chiusura"){ stats[d].ch++; if(we) stats[d].chWE++; }
    }
  }
  const nWeeks=Math.max(1,weeksSet.size);
  const avg={}; dips.forEach(d=>avg[d]={ap:stats[d].ap/nWeeks, ch:stats[d].ch/nWeeks, apWE:stats[d].apWE/nWeeks, chWE:stats[d].chWE/nWeeks});

  // outlier alto/basso per bias
  const outAp=assessBalanceShares(dips.map(d=>stats[d].ap));
  const outCh=assessBalanceShares(dips.map(d=>stats[d].ch));
  const outApW=assessBalanceShares(dips.map(d=>stats[d].apWE));
  const outChW=assessBalanceShares(dips.map(d=>stats[d].chWE));
  const hiAp=new Set(outAp.hi.map(i=>dips[i])), loAp=new Set(outAp.lo.map(i=>dips[i]));
  const hiCh=new Set(outCh.hi.map(i=>dips[i])), loCh=new Set(outCh.lo.map(i=>dips[i]));
  const hiApW=new Set(outApW.hi.map(i=>dips[i])), loApW=new Set(outApW.lo.map(i=>dips[i]));
  const hiChW=new Set(outChW.hi.map(i=>dips[i])), loChW=new Set(outChW.lo.map(i=>dips[i]));

  // settimana proposta
  const start=mondayOfNextWeek(maxDate||new Date());
  const end=addDays(start,6);
  document.getElementById("badgeWeek").textContent=`Settimana: ${isoWeek(start)}/${isoWeekYear(start)}`;
  document.getElementById("badgeRange").textContent=`Periodo: ${start.toLocaleDateString('it-IT')} ‚Üí ${end.toLocaleDateString('it-IT')}`;
  const daysLabel=["Luned√¨","Marted√¨","Mercoled√¨","Gioved√¨","Venerd√¨","Sabato","Domenica"];
  for(let i=0;i<7;i++){ const d=addDays(start,i); document.getElementById("d"+i).textContent=`${daysLabel[i]} ${d.toLocaleDateString('it-IT')}`; }

  function generate(intensity, compSlots){
    // ore restanti e assegnazioni conteggio
    const remaining={}; const assigned={};
    dips.forEach(n=>{ remaining[n]=(CONTRACT_HOURS[n]??30); assigned[n]={open:0, close:0, openWE:0, closeWE:0, hours:0}; });

    // matrice giornaliera (una cella = stringa)
    const grid=Array.from({length:dips.length}, ()=>Array(7).fill("riposo"));

    // selettore candidato
    function pick(role, dayIdx){
      const dayDate=addDays(start,dayIdx);
      const isWE=(dayDate.getDay()===0||dayDate.getDay()===6)||isHoliday(dayDate);
      const avoid = role==="open" ? (isWE? hiApW:hiAp) : (isWE? hiChW:hiCh);
      const prefer= role==="open" ? (isWE? loApW:loAp) : (isWE? loChW:loCh);

      const rank=dips.map(name=>{
        const usedToday = grid[dips.indexOf(name)][dayIdx] !== "riposo";
        let score=0;
        // pi√π ore rimaste => priorit√†
        score -= remaining[name]/10;
        // penalizza se gi√† usato oggi
        if(usedToday) score += 100;
        // bias outlier
        if(prefer.has(name)) score -= (1.5*intensity);
        if(avoid.has(name))  score += (1.5*intensity);
        // non superare monte ore
        if(remaining[name] < 4) score += 50;
        return {name,score};
      }).sort((a,b)=>a.score-b.score);

      for(const cand of rank){
        const row=dips.indexOf(cand.name);
        if(grid[row][dayIdx]==="riposo" && remaining[cand.name] >= 4) return cand.name;
      }
      // fallback: nessuno adatto ‚Üí concede a chi ha pi√π ore residue
      return rank.sort((a,b)=>remaining[b.name]-remaining[a.name])[0].name;
    }

    // Schema giornaliero: O + C sempre; M1 e M2 fino a compSlots
    for(let day=0; day<7; day++){
      const roles=["O","C"];
      if(compSlots>=1) roles.splice(1,0,"M1"); // O, M1, C
      if(compSlots>=2) roles.splice(2,0,"M2"); // O, M1, M2, C
      if(compSlots>=3) roles.splice(2,0,"M2"); // raddoppia M2: O, M1, M2, M2, C

      const pickedByRole={};

      for(const r of roles){
        // evita stessa persona in due turni lo stesso giorno
        let candidate=pick(r,day);
        const taken=new Set(Object.values(pickedByRole));
        if(taken.has(candidate)){
          const alt=dips.find(n=>!taken.has(n) && (remaining[n]||0)>=4 && grid[dips.indexOf(n)][day]==="riposo");
          if(alt) candidate=alt;
        }
        pickedByRole[r]=candidate;

        const row=dips.indexOf(candidate);
        const label = r==="O"?"9‚Äì13": r==="M1"?"12‚Äì16": r==="M2"?"13‚Äì17":"16‚Äì20";
        const css   = r==="O"?"open": r==="C"?"close":"mid";
        grid[row][day] = `<div class="${css}" title="${label}">${label}</div>`;
        remaining[candidate]-=4;
        assigned[candidate].hours+=4;

        const date=addDays(start,day);
        const WE=(date.getDay()===0||date.getDay()===6)||isHoliday(date);
        if(r==="O"){ assigned[candidate].open += 1; if(WE) assigned[candidate].openWE += 1; }
        if(r==="C"){ assigned[candidate].close+= 1; if(WE) assigned[candidate].closeWE+= 1; }
      }
    }

    // Domenica ‚Üí REC in settimana (mercoled√¨ preferito, altrimenti primo giorno utile)
    for(let i=0;i<dips.length;i++){
      const name=dips[i];
      const workedSun = /div/.test(grid[i][6]); // se cella non √® "riposo"
      if(workedSun){
        const pref=[2,0,1,3,4,5]; // mercoled√¨ -> lun -> mar -> gio -> ven -> sab
        for(const d of pref){
          // non rompere copertura: assegna REC solo se quel giorno non era gi√† un turno
          if(typeof grid[i][d]==="string" && grid[i][d]==="riposo"){
            grid[i][d] = `<div class="rec" title="REC">REC</div>`;
            break;
          }
        }
      }
    }

    // Marca RIPOSO per chi ha esaurito ore: gi√† "riposo"; per chiarezza non cambiamo label
    return {grid, assigned, remaining};
  }

  function render(result){
    const {grid, assigned}=result;
    const tbody=document.getElementById("tbody");
    tbody.innerHTML=dips.map((name,r)=>`<tr>
      <td>${name}</td>
      ${grid[r].map(cell=>`<td>${cell}</td>`).join("")}
    </tr>`).join("");

    // ore assegnate vs contratto
    const hBody=document.getElementById("hoursBody");
    hBody.innerHTML=dips.map(name=>{
      const as=assigned[name].hours||0, ct=(CONTRACT_HOURS[name]??30);
      const delta = as-ct;
      const htmlDelta = (delta===0? "0" : (delta>0? `+${delta}` : `${delta}`));
      return `<tr>
        <td>${name}</td>
        <td style="text-align:center">${as}</td>
        <td style="text-align:center">${ct}</td>
        <td style="text-align:center">${htmlDelta}</td>
      </tr>`;
    }).join("");
  }

  // prima generazione
  let intensity=1, compSlots=1;
  let cur=generate(intensity, compSlots);
  render(cur);

  document.getElementById("regen").addEventListener("click", ()=>{
    intensity = parseInt(document.getElementById("intensity").value,10)||1;
    compSlots = parseInt(document.getElementById("compSlots").value,10)||0;
    cur = generate(intensity, compSlots);
    render(cur);
  });

})().catch(err=>{
  console.error(err);
  alert("Errore: "+err.message+"\nControlla che il foglio sia pubblicato e raggiungibile.");
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<title>Planner Orari ‚Äì Settimana Successiva</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --border:#e6e8f0; --muted:#6b7280; --ink:#0f172a;
    --open:#dff7df; --close:#e5f0ff; --rest:#f3f4f6; --accent:#0ea5e9; --danger:#dc2626;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:0 auto;padding:18px 20px}
  header .wrap{display:flex;flex-direction:column;align-items:center;text-align:center}
  h1{margin:0;font-size:22px}
  .badges{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px}
  .badge{display:inline-flex;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--card);font-size:12px}
  .sub{color:var(--muted);font-size:12px;margin-top:6px}
  main.wrap{display:flex;flex-direction:column;gap:18px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px}
  .card-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .card-title{margin:0;font-size:16px}
  .controls{display:flex;align-items:center;gap:10px;font-size:14px}
  .table-wrap{border:1px solid var(--border);border-radius:12px;overflow:auto;max-height:72vh;background:#fff}
  table{width:100%;border-collapse:separate;border-spacing:0;font-size:15px;min-width:900px}
  thead th{position:sticky;top:0;background:#fff;z-index:2;border-bottom:1px solid var(--border);padding:10px 8px;white-space:nowrap}
  tbody td{padding:12px 10px;border-bottom:1px solid var(--border)}
  th:first-child,td:first-child{position:sticky;left:0;background:#fff;z-index:3}
  th:first-child,td:first-child{text-align:left;width:220px}
  .open{background:var(--open)}
  .close{background:var(--close)}
  .rest{background:var(--rest);color:#374151}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #d1d5db}
  .legend{font-size:13px;color:#111}
  .legend b{font-weight:600}
  .ring{display:inline-flex;align-items:center;justify-content:center;min-width:2.4ch;padding:0 6px;border:2px solid var(--danger);border-radius:999px}
  .muted{color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>üóìÔ∏è Planner Orari ‚Äì Settimana Successiva</h1>
    <div class="badges">
      <div class="badge" id="badgeWeek">Settimana generata: ‚Äî</div>
      <div class="badge" id="badgeRange">Periodo: ‚Äî</div>
      <div class="badge" id="badgeUpdated">Aggiornato: ‚Äî</div>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <div class="card-header">
      <h2 class="card-title">Proposta turni (copertura 9‚Äì20 con apertura/chiusura)</h2>
      <div class="controls">
        Intensit√† correzione:
        <select id="intensity">
          <option value="1" selected>+1/-1 (soft)</option>
          <option value="2">+2/-2 (pi√π forte)</option>
        </select>
        <button id="regen" class="pill">Rigenera</button>
      </div>
    </div>
    <div class="table-wrap">
      <table id="planTable" aria-live="polite">
        <thead>
          <tr>
            <th>Dipendente</th>
            <th id="d0">Luned√¨</th>
            <th id="d1">Marted√¨</th>
            <th id="d2">Mercoled√¨</th>
            <th id="d3">Gioved√¨</th>
            <th id="d4">Venerd√¨</th>
            <th id="d5">Sabato</th>
            <th id="d6">Domenica</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="wrap legend" style="padding:10px 16px 16px">
      <div><span class="pill" style="background:var(--open)">9‚Äì14</span> = Apertura ‚Ä¢ <span class="pill" style="background:var(--close)">14‚Äì20</span> = Chiusura ‚Ä¢ <span class="pill rest">Riposo</span></div>
      <div class="muted" style="margin-top:6px">Algoritmo: preferisce chi √® ‚Äúin difetto‚Äù (outlier basso) ed evita chi √® ‚Äúin eccesso‚Äù (outlier alto) su <b>Aperture</b>, <b>Chiusure</b> e versioni <b>WE/Festivi</b>. Garantita 1 Apertura + 1 Chiusura al giorno.</div>
    </div>
  </section>

  <section class="card">
    <div class="card-header"><h2 class="card-title">Correzioni applicate (vs media settimanale storica)</h2></div>
    <div class="table-wrap">
      <table id="deltaTable">
        <thead><tr><th>Dipendente</th><th>Aperture</th><th>Chiusure</th><th>Aperture WE/Festivi</th><th>Chiusure WE/Festivi</th></tr></thead>
        <tbody id="deltaBody"></tbody>
      </table>
    </div>
    <div class="wrap muted" style="padding:10px 16px 16px">Valori = (assegnati nella nuova settimana) ‚àí (media settimanale storica). Il bordo rosso evidenzia l‚Äôoutlier originale di ciascuna metrica.</div>
  </section>
</main>

<script>
const PUBHTML = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTiGFO5sDWqthBzsCJ08wsG5bM4BjidbyZBwRXt32IuAkcr0BWhCmSTA-ZyayT07w/pubhtml?gid=876412715&single=true";

// ---------- util date ----------
function toYMD(d){ return d.toISOString().slice(0,10); }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function mondayOfNextWeek(base){
  const b = new Date(base); const day = b.getDay()||7; // 1..7 (lun..dom)
  const monday = addDays(b, 1 - day); // lun di questa settimana
  return addDays(monday, 7);          // lun prossimo
}
function isoWeek(date){
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const day = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - day);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}
function isoWeekYear(date){
  const d = new Date(date.getTime());
  d.setDate(d.getDate() + 4 - (d.getDay() || 7));
  return d.getFullYear();
}
function parseItaDate(dstr){
  if (!dstr) return null;
  if (/^\d{4}-\d{2}-\d{2}$/.test(dstr)) return new Date(dstr);
  const m = dstr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (!m) return new Date(dstr);
  return new Date(+m[3], +m[2]-1, +m[1]);
}

// ---------- holidays IT ----------
function easterSunday(year){
  const a=year%19,b=Math.floor(year/100),c=year%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25);
  const g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451);
  const month=Math.floor((h+l-7*m+114)/31), day=((h+l-7*m+114)%31)+1;
  return new Date(year, month-1, day);
}
function italianHolidays(year){
  const set=new Set(); const add=(m,d)=>set.add(toYMD(new Date(year,m-1,d)));
  add(1,1); add(1,6); add(4,25); add(5,1); add(6,2); add(8,15); add(11,1); add(12,8); add(12,25); add(12,26);
  const easter=easterSunday(year), pasquetta=addDays(easter,1);
  set.add(toYMD(easter)); set.add(toYMD(pasquetta));
  return set;
}
const holidaysMap = new Map();
function isHoliday(date){
  const y=date.getFullYear();
  if(!holidaysMap.has(y)) holidaysMap.set(y, italianHolidays(y));
  return holidaysMap.get(y).has(toYMD(date));
}

// ---------- fetch CSV ----------
function getPubInfo(pubhtml){
  const idm = pubhtml.match(/\/d\/e\/([^/]+)\/pubhtml/);
  const gidm = pubhtml.match(/[?&]gid=(\d+)/);
  return { pubId: idm[1], gid: gidm ? gidm[1] : "0" };
}
async function fetchCSV(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error(`Fetch failed ${r.status}`);
  const text = await r.text();
  const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
  return parsed.data;
}

// ---------- stats ----------
function assessBalanceShares(values){
  const sum = values.reduce((a,b)=>a+b,0);
  if (sum<=0) return {balanced:true, outHigh:[], outLow:[], shares:values.map(_=>0)};
  const shares = values.map(v=>v/sum);
  const maxShare = Math.max(...shares), minShare = Math.min(...shares);
  const balanced = (maxShare - minShare) <= 0.05; // 5pp
  const outHighIdx = shares.map((s,i)=>s===maxShare?i:null).filter(i=>i!==null);
  const outLowIdx  = shares.map((s,i)=>s===minShare?i:null).filter(i=>i!==null);
  return {balanced, outHigh:outHighIdx, outLow:outLowIdx, shares};
}

(async function main(){
  // header badges
  const now = new Date();
  document.getElementById("badgeUpdated").textContent = "Aggiornato: " + now.toLocaleDateString('it-IT') + " " + now.toLocaleTimeString('it-IT');

  const { pubId, gid } = getPubInfo(PUBHTML);
  let csvUrl = `https://docs.google.com/spreadsheets/d/e/${pubId}/pub?gid=${gid}&single=true&output=csv`;
  let rows;
  try { rows = await fetchCSV(csvUrl); }
  catch(e){ csvUrl = `https://docs.google.com/spreadsheets/d/e/${pubId}/gviz/tq?gid=${gid}&tqx=out:csv`; rows = await fetchCSV(csvUrl); }

  const headers = rows.length?Object.keys(rows[0]):[];
  const colData = headers.find(k=>k.toLowerCase().includes("data"));
  const dipCols = headers.filter(k=>/ilenia|cinzia|michela|vivien/i.test(k));
  const dips = dipCols.slice();

  // indice per data + stats storiche
  const byDate = new Map();
  let minDate=null, maxDate=null;
  const stats = {};
  dips.forEach(d => stats[d] = {ap:0, ch:0, apWE:0, chWE:0, weeks:new Set()});

  for (const r of rows){
    const dt = parseItaDate(r[colData]); if(!dt||isNaN(+dt)) continue;
    if(!minDate || dt<minDate) minDate=dt; if(!maxDate || dt>maxDate) maxDate=dt;
    const ymd = toYMD(dt); const dow = dt.getDay(); const we = (dow===0||dow===6) || isHoliday(dt);
    if(!byDate.has(ymd)) byDate.set(ymd, {});
    const day = byDate.get(ymd);

    for (const d of dips){
      const v = (r[d]||"").toString().trim().toLowerCase();
      day[d]=v;
      if (v==="apertura"){ stats[d].ap++; if(we) stats[d].apWE++; }
      else if (v==="chiusura"){ stats[d].ch++; if(we) stats[d].chWE++; }
    }
  }

  // settimane coperte per media settimanale
  // usa ISO settimane nel range minDate..maxDate
  const weeksSet = new Set();
  if(minDate && maxDate){
    for(let dd=new Date(minDate); dd<=maxDate; dd=addDays(dd,1)){
      weeksSet.add(`${isoWeekYear(dd)}-W${String(isoWeek(dd)).padStart(2,"0")}`);
    }
  }
  const nWeeks = Math.max(1, weeksSet.size);

  // medie settimanali per metrica/dip
  const weeklyAvg = {};
  dips.forEach(d=>{
    weeklyAvg[d] = {
      ap: stats[d].ap / nWeeks,
      ch: stats[d].ch / nWeeks,
      apWE: stats[d].apWE / nWeeks,
      chWE: stats[d].chWE / nWeeks
    };
  });

  // outlier (alto/basso) per bias
  function valuesOf(key){ return dips.map(d => ({d, v: stats[d][key]})); }
  const outAp  = assessBalanceShares(dips.map(d=>stats[d].ap));
  const outCh  = assessBalanceShares(dips.map(d=>stats[d].ch));
  const outApW = assessBalanceShares(dips.map(d=>stats[d].apWE));
  const outChW = assessBalanceShares(dips.map(d=>stats[d].chWE));
  const lowAp  = new Set(outAp.outLow.map(i=>dips[i])),  highAp  = new Set(outAp.outHigh.map(i=>dips[i]));
  const lowCh  = new Set(outCh.outLow.map(i=>dips[i])),  highCh  = new Set(outCh.outHigh.map(i=>dips[i]));
  const lowApW = new Set(outApW.outLow.map(i=>dips[i])), highApW = new Set(outApW.outHigh.map(i=>dips[i]));
  const lowChW = new Set(outChW.outLow.map(i=>dips[i])), highChW = new Set(outChW.outHigh.map(i=>dips[i]));

  // settimana da generare = luned√¨ successivo all'ultima data presente
  const start = mondayOfNextWeek(maxDate || new Date());
  const end = addDays(start,6);
  document.getElementById("badgeWeek").textContent = `Settimana ISO: ${isoWeek(start)}/${isoWeekYear(start)}`;
  document.getElementById("badgeRange").textContent = `Periodo: ${start.toLocaleDateString('it-IT')} ‚Üí ${end.toLocaleDateString('it-IT')}`;

  // header giorni con data
  const giorni = ["Luned√¨","Marted√¨","Mercoled√¨","Gioved√¨","Venerd√¨","Sabato","Domenica"];
  for(let i=0;i<7;i++){
    const d = addDays(start,i);
    document.getElementById("d"+i).textContent = `${giorni[i]} ${d.toLocaleDateString('it-IT')}`;
  }

  // funzione generazione
  function generate(intensity){
    // contatori pianificazione settimana
    const plan = {}; dips.forEach(d=> plan[d] = {open:0, close:0, openWE:0, closeWE:0});
    const grid = Array.from({length:dips.length}, ()=>Array(7).fill("riposo"));

    function pick(role, dayIdx){
      const d = addDays(start, dayIdx);
      const isWE = (d.getDay()===0 || d.getDay()===6) || isHoliday(d);
      const avoid = role==="open"
        ? (isWE? highApW : highAp)
        : (isWE? highChW : highCh);
      const prefer = role==="open"
        ? (isWE? lowApW : lowAp)
        : (isWE? lowChW : lowCh);

      // ranking: meno assegnazioni di quel ruolo prima; priorit√† ai "prefer", penalizza "avoid"
      const ranking = dips.map(name=>{
        const base = role==="open" ? (isWE? plan[name].openWE : plan[name].open)
                                   : (isWE? plan[name].closeWE : plan[name].close);
        let score = base;
        if (prefer.has(name)) score -= (2 + intensity);   // forte spinta verso chi √® in difetto
        if (avoid.has(name))  score += (2 + intensity);   // evita chi √® in eccesso
        return {name, score};
      }).sort((a,b)=>a.score-b.score);

      // non assegnare la stessa persona a apertura e chiusura nello stesso giorno
      for (const cand of ranking){
        const row = dips.indexOf(cand.name);
        if (grid[row][dayIdx] === "riposo") return cand.name;
      }
      // fallback (dovrebbe mai servire)
      return ranking[0].name;
    }

    for(let day=0; day<7; day++){
      const opener = pick("open", day);
      const closer = (()=>{ // assicurati diverso da opener
        let c = pick("close", day);
        if (c === opener){
          // scegli il secondo
          const others = dips.filter(n=>n!==opener);
          c = others[Math.floor(Math.random()*others.length)];
        }
        return c;
      })();

      const isWE = (addDays(start,day).getDay()===0 || addDays(start,day).getDay()===6) || isHoliday(addDays(start,day));

      // scrivi griglia
      dips.forEach((name, r)=>{
        if (name===opener){ grid[r][day] = "apertura"; if(isWE) plan[name].openWE++; else plan[name].open++; }
        else if (name===closer){ grid[r][day] = "chiusura"; if(isWE) plan[name].closeWE++; else plan[name].close++; }
        else { grid[r][day] = "riposo"; }
      });
    }

    return {grid, plan};
  }

  // render tabella + delta
  function render(result){
    const {grid, plan} = result;
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = dips.map((name, r)=>{
      const tds = grid[r].map(v=>{
        if (v==="apertura") return `<td class="open" title="apertura">9‚Äì14</td>`;
        if (v==="chiusura") return `<td class="close" title="chiusura">14‚Äì20</td>`;
        return `<td class="rest">riposo</td>`;
      }).join("");
      return `<tr><td>${name}</td>${tds}</tr>`;
    }).join("");

    // delta vs medie settimanali
    const dBody = document.getElementById("deltaBody");
    dBody.innerHTML = dips.map(name=>{
      const avg = weeklyAvg[name];
      const dAp  = (plan[name].open  - avg.ap).toFixed(1);
      const dCh  = (plan[name].close - avg.ch).toFixed(1);
      const dApW = (plan[name].openWE  - avg.apWE).toFixed(1);
      const dChW = (plan[name].closeWE - avg.chWE).toFixed(1);
      // bollini sull'outlier originale
      const mark = (metric, valHTML)=>{
        const isOut =
          (metric==="ap"  && (Array.from(highAp).includes(name) || Array.from(lowAp).includes(name))) ||
          (metric==="ch"  && (Array.from(highCh).includes(name) || Array.from(lowCh).includes(name))) ||
          (metric==="apW" && (Array.from(highApW).includes(name) || Array.from(lowApW).includes(name))) ||
          (metric==="chW" && (Array.from(highChW).includes(name) || Array.from(lowChW).includes(name)));
        return isOut ? `<span class="ring">${valHTML}</span>` : valHTML;
      };
      const fmt = v => (Number(v)>=0?`+${v}`:v);
      return `<tr>
        <td>${name}</td>
        <td style="text-align:center">${mark("ap", fmt(dAp))}</td>
        <td style="text-align:center">${mark("ch", fmt(dCh))}</td>
        <td style="text-align:center">${mark("apW", fmt(dApW))}</td>
        <td style="text-align:center">${mark("chW", fmt(dChW))}</td>
      </tr>`;
    }).join("");
  }

  // prima generazione
  let cur = generate(1);
  render(cur);

  // rigenera con intensit√† scelta
  document.getElementById("regen").addEventListener("click", ()=>{
    const k = parseInt(document.getElementById("intensity").value,10) || 1;
    cur = generate(k);
    render(cur);
  });

})().catch(err=>{
  console.error(err);
  alert("Errore: " + err.message + "\nControlla che il foglio sia pubblicato e raggiungibile.");
});
</script>
</body>
</html>

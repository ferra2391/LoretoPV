<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<title>Planner Orari ‚Äì Settimana Successiva</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root{ --bg:#f6f7fb; --card:#fff; --border:#e6e8f0; --muted:#6b7280; --ink:#0f172a;
         --open:#dff7df; --close:#e5f0ff; --rest:#f3f4f6; --rec:#ffe7ec;
         --danger:#dc2626; --ok:#16a34a; }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:0 auto;padding:18px 20px}
  header .wrap{display:flex;flex-direction:column;align-items:center;text-align:center}
  h1{margin:0;font-size:22px}
  .badges{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px}
  .badge{display:inline-flex;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;font-size:12px}

  main.wrap{display:flex;flex-direction:column;gap:18px}
  .card{background:#fff;border:1px solid var(--border);border-radius:16px}
  .card-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .card-title{margin:0;font-size:16px}
  .pill{display:inline-block;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer}

  .grid-wrap{border:1px solid var(--border);border-radius:12px;overflow:auto;background:#fff}
  table{width:100%;border-collapse:separate;border-spacing:0;min-width:980px;font-size:15px}
  thead th{position:sticky;top:0;background:#fff;z-index:2;border-bottom:1px solid var(--border);padding:10px 8px;white-space:nowrap}
  thead th .th-day{display:block;line-height:1.1}
  thead th .th-sub{display:block;color:var(--muted);font-size:12px;margin-top:2px}
  tbody td{padding:10px 8px;border-bottom:1px solid var(--border);vertical-align:top}
  th:first-child,td:first-child{position:sticky;left:0;background:#fff;z-index:3}
  th:first-child,td:first-child{text-align:left;width:220px}

  .open{background:var(--open)}
  .close{background:var(--close)}
  .rest{background:var(--rest);color:#374151}
  .rec{background:var(--rec)}
  .delta-ok{color:var(--ok);font-weight:600}
  .delta-bad{color:var(--danger);font-weight:600}
  .alert{background:#fff7e6;border:1px solid #ffe5b4;border-radius:10px;padding:10px 12px;color:#8a6100}

  .abs-num{width:74px;padding:4px 6px}
  .abs-num::-webkit-outer-spin-button,
  .abs-num::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
  .subrow-label{color:#6b7280;font-size:12px}
  .emp-name{font-weight:600}
  .divider td{border-top:2px solid #e5e7eb}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>üóìÔ∏è Planner Orari ‚Äì Settimana Successiva</h1>
    <div class="badges">
      <div class="badge" id="badgeWeek">Settimana: ‚Äî</div>
      <div class="badge" id="badgeRange">Periodo: ‚Äî</div>
      <div class="badge" id="badgeUpdated">Aggiornato: ‚Äî</div>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <div class="card-header">
      <h2 class="card-title">Proposta turni (9‚Äì13/14/15 ‚Ä¢ 13/14/15‚Äì20) ‚Äì compresenza automatica</h2>
      <div>
        <button id="regen" class="pill">Rigenera</button>
        <button id="applyAbs" class="pill">Applica assenze</button>
      </div>
    </div>

    <div class="grid-wrap">
      <table id="planTable">
        <thead>
          <tr>
            <th>Dipendente</th>
            <th id="d0">Luned√¨</th><th id="d1">Marted√¨</th><th id="d2">Mercoled√¨</th>
            <th id="d3">Gioved√¨</th><th id="d4">Venerd√¨</th><th id="d5">Sabato</th><th id="d6">Domenica</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div id="impossibleAlert" class="alert" style="display:none; margin: 10px 16px 16px;"></div>
  </section>

  <section class="card">
    <div class="card-header"><h2 class="card-title">Ore assegnate vs contratto (settimana proposta)</h2></div>
    <div class="grid-wrap">
      <table id="hoursTable">
        <thead><tr><th>Dipendente</th><th>Ore assegnate</th><th>Contratto</th><th>Delta</th></tr></thead>
        <tbody id="hoursBody"></tbody>
      </table>
    </div>
  </section>
</main>

<script>
// ====== CONFIG ======
const PUBHTML = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTiGFO5sDWqthBzsCJ08wsG5bM4BjidbyZBwRXt32IuAkcr0BWhCmSTA-ZyayT07w/pubhtml?gid=876412715&single=true";
const CONTRACT_HOURS = { Ilenia:30, Cinzia:35, Vivien:35, Michela:32 };
const OPENERS = [{h:6,label:"9‚Äì15"},{h:5,label:"9‚Äì14"},{h:4,label:"9‚Äì13"}];
const CLOSERS = [{h:7,label:"13‚Äì20"},{h:6,label:"14‚Äì20"},{h:5,label:"15‚Äì20"}];
let regenTick = 0;

// ==== utils date ====
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function parseItaDate(s){ if(!s) return null; if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s); const m=s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/); if(!m) return new Date(s); return new Date(+m[3],+m[2]-1,+m[1]); }
function mondayOfNextWeek(base){ const b=new Date(base); const day=b.getDay()||7; const monday=addDays(b,1-day); return addDays(monday,7); }
function isoWeek(d){ const x=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate())); const wd=x.getUTCDay()||7; x.setUTCDate(x.getUTCDate()+4-wd); const y0=new Date(Date.UTC(x.getUTCFullYear(),0,1)); return Math.ceil((((x-y0)/86400000)+1)/7); }
function isoWeekYear(d){ const x=new Date(d.getTime()); x.setDate(x.getDate()+4-(x.getDay()||7)); return x.getFullYear(); }
function ddmm(d){ return String(d.getDate()).padStart(2,'0') + "/" + String(d.getMonth()+1).padStart(2,'0'); }

// ==== CSV ====
function getPubInfo(pubhtml){ const idm=pubhtml.match(/\/d\/e\/([^/]+)\/pubhtml/); const gidm=pubhtml.match(/[?&]gid=(\d+)/); return {pubId:idm[1], gid: gidm?gidm[1]:"0"}; }
async function fetchCSV(url){ const r=await fetch(url); if(!r.ok) throw new Error(`Fetch failed ${r.status}`); const t=await r.text(); return Papa.parse(t,{header:true,skipEmptyLines:true}).data; }

// ==== main ====
(async function main(){
  const now=new Date();
  document.getElementById("badgeUpdated").textContent = "Aggiornato: "+now.toLocaleDateString('it-IT')+" "+now.toLocaleTimeString('it-IT');

  const {pubId,gid}=getPubInfo(PUBHTML);
  let csv=`https://docs.google.com/spreadsheets/d/e/${pubId}/pub?gid=${gid}&single=true&output=csv`;
  let rows; try{ rows=await fetchCSV(csv);}catch{ csv=`https://docs.google.com/spreadsheets/d/e/${pubId}/gviz/tq?gid=${gid}&tqx=out:csv`; rows=await fetchCSV(csv); }

  const headers=rows.length?Object.keys(rows[0]):[];
  const colData=headers.find(k=>k.toLowerCase().includes("data"));
  const dipCols=headers.filter(k=>/ilenia|cinzia|michela|vivien/i.test(k));
  const dips=dipCols.slice();

  // range
  let maxDate=null;
  for(const r of rows){ const dt=parseItaDate(r[colData]); if(!dt||isNaN(+dt)) continue; if(!maxDate||dt>maxDate) maxDate=dt; }
  const start=mondayOfNextWeek(maxDate||new Date());
  const end=addDays(start,6);
  const daysLabel=["Luned√¨","Marted√¨","Mercoled√¨","Gioved√¨","Venerd√¨","Sabato","Domenica"];
  for(let i=0;i<7;i++){
    const d=addDays(start,i);
    document.getElementById("d"+i).innerHTML = `<span class="th-day">${daysLabel[i]}<span class="th-sub">${ddmm(d)}</span></span>`;
  }
  document.getElementById("badgeWeek").textContent=`Settimana: ${isoWeek(start)}/${isoWeekYear(start)}`;
  document.getElementById("badgeRange").textContent=`Periodo: ${start.toLocaleDateString('it-IT')} ‚Üí ${end.toLocaleDateString('it-IT')}`;

  const tbody=document.getElementById("tbody");

  // ===== skeleton (senza rowspan) =====
  function rowShift(name, idx){
    return `<tr class="divider"><td class="emp-name">${name}</td>${
      Array.from({length:7},(_,d)=>`<td id="cell-${idx}-${d}"><div class="rest">riposo</div></td>`).join("")
    }</tr>`;
  }
  function rowAbs(name, type){
    const show = (type!=="104") || /^cinzia$/i.test(name);
    if(!show) return "";
    return `<tr><td class="subrow-label">${type[0].toUpperCase()+type.slice(1)}</td>${
      Array.from({length:7},()=>`<td>
        <input class="abs-num" type="number" min="0" max="8" step="1" inputmode="numeric" placeholder="0" data-type="${type}">
      </td>`).join("")
    }</tr>`;
  }
  function renderSkeleton(){
    tbody.innerHTML = dips.map((name, idx)=>{
      return rowShift(name, idx) + rowAbs(name,"ferie") + rowAbs(name,"malattia") + rowAbs(name,"104");
    }).join("");
  }
  renderSkeleton();

  // utility per shift cell (con dataset)
  function writeShiftCell(r, day, side, hours){
    const label = side==='open'
      ? (hours===6?"9‚Äì15": hours===5?"9‚Äì14":"9‚Äì13")
      : (hours===7?"13‚Äì20": hours===6?"14‚Äì20":"15‚Äì20");
    const cls = side==='open'?'open':'close';
    const html = `<div class="${cls}" data-type="${side}" data-hours="${hours}" data-label="${label}"><b>${label}</b> (${hours}h)</div>`;
    document.getElementById(`cell-${r}-${day}`).innerHTML = html;
  }
  function cellInfo(r, day){
    const el = document.getElementById(`cell-${r}-${day}`).firstElementChild;
    if(!el) return null;
    const type = el.dataset?.type;
    const hours = el.dataset?.hours ? Number(el.dataset.hours) : null;
    if(!type || hours==null || isNaN(hours)) return null;
    return {type, hours, label: el.dataset.label, el};
  }

  // mutual exclusive nello stesso giorno/utente
  tbody.addEventListener('input', (e)=>{
    const el = e.target;
    if(!el.classList.contains('abs-num')) return;
    const td = el.closest('td'); const day = td.cellIndex - 1;
    const type = el.dataset.type;
    const value = Number(el.value)||0;

    if(value>0){
      // trova top di blocco (riga con Nome)
      const blockTop = (()=>{ let p=el.closest('tr').previousElementSibling; while(p && !p.querySelector('.emp-name')) p=p.previousElementSibling; return p; })();
      const subRows = []; let n=blockTop.nextElementSibling;
      while(n && n.querySelector('.subrow-label')){ subRows.push(n); n=n.nextElementSibling; }
      subRows.forEach(r=>{
        const lab=r.querySelector('.subrow-label').textContent.trim().toLowerCase();
        if(lab!==type){
          const other=r.children[day+1]?.querySelector('.abs-num');
          if(other) other.value="";
        }
      });
    }
  });

  document.getElementById("applyAbs").addEventListener("click", ()=>regenerate());
  document.getElementById("regen").addEventListener("click", ()=>{ regenTick++; regenerate(); });

  function readAbsences(){
    const abs = {}; dips.forEach(n=>abs[n]=Array(7).fill({type:"none",hrs:0}));
    let row=0, emp=0;
    while(row<tbody.children.length){
      const r = tbody.children[row];
      if(r.querySelector('.emp-name')){
        const name = dips[emp];
        let s=row+1;
        while(s<tbody.children.length && tbody.children[s].querySelector('.subrow-label')){
          const lab = tbody.children[s].querySelector('.subrow-label').textContent.trim().toLowerCase();
          for(let d=1; d<=7; d++){
            const el = tbody.children[s].children[d]?.querySelector('.abs-num');
            if(!el) continue;
            const hrs = Number(el.value)||0;
            if(hrs>0) abs[name][d-1] = {type:lab, hrs};
          }
          s++;
        }
        emp++; row=s;
      } else row++;
    }
    return abs;
  }

  // helpers
  function hasShift(r,day){ return !!document.getElementById(`cell-${r}-${day}`).firstElementChild?.dataset?.type; }
  function countDay(day){
    let open=0, close=0;
    for(let r=0;r<dips.length;r++){
      const info = cellInfo(r,day);
      if(!info) continue;
      if(info.type==='open') open++;
      if(info.type==='close') close++;
    }
    return {open, close};
  }
  function pickByRemain(cands, used, remain, minH, dir=1){
    const list = cands.filter(n=>!used.has(n) && remain[n]>=minH)
                      .sort((a,b)=> (remain[b]-remain[a]) || dir*b.localeCompare(a));
    return list[0] || null;
  }

  function regenerate(){
    try{
      const abs=readAbsences();
      const res=generate(abs);
      render(res);
    }catch(e){ console.error(e); alert("Errore durante il ricalcolo: "+e.message); }
  }

  // ============ GENERATE (priorit√† Domenica) ============
  function generate(abs){
    // residui = contratto - assenze
    const remain={}, assigned={};
    dips.forEach(n=>{ remain[n]=CONTRACT_HOURS[n]||0; assigned[n]={hours:0}; });
    for(const name of dips){
      for(let d=0; d<7; d++){
        const ev=abs[name][d];
        if(ev && ev.type!=="none"){ remain[name]=Math.max(0,remain[name]-ev.hrs); assigned[name].hours+=ev.hrs; }
      }
    }
    // reset
    for(let r=0;r<dips.length;r++){
      for(let d=0; d<7; d++){
        const ev=abs[dips[r]][d];
        document.getElementById(`cell-${r}-${d}`).innerHTML =
          (ev && ev.type!=="none") ? `<div class="rec" title="${ev.type.toUpperCase()} ${ev.hrs}h">${ev.type.toUpperCase()} ${ev.hrs}h</div>` : `<div class="rest">riposo</div>`;
      }
    }

    const dayOrder = [6,5,0,1,2,3,4]; // Dom, Sab, Lun..Ven
    const dipsOrdered = dips.slice(regenTick % dips.length).concat(dips.slice(0, regenTick % dips.length));
    const baseCombos0 = [
      {openH:5, closeH:6},
      {openH:6, closeH:5},
      {openH:4, closeH:7}
    ];
    const baseCombos = baseCombos0.map((_,i)=>baseCombos0[(i+regenTick)%baseCombos0.length]);

    // copertura base + compresenze
    for(const day of dayOrder){
      const available = dipsOrdered.filter(n=>abs[n][day].type==="none");
      const used = new Set();
      let paired=false;

      for(const c of baseCombos){
        const opener = pickByRemain(available, used, remain, c.openH, regenTick%2===0?1:-1);
        if(!opener) continue;
        used.add(opener);
        const closer = pickByRemain(available.filter(n=>n!==opener), used, remain, c.closeH, regenTick%2===0?1:-1);
        if(!closer){ used.delete(opener); continue; }

        const rOpen=dips.indexOf(opener), rClose=dips.indexOf(closer);
        writeShiftCell(rOpen, day, 'open', c.openH);
        writeShiftCell(rClose, day, 'close', c.closeH);
        remain[opener]-=c.openH; assigned[opener].hours+=c.openH;
        remain[closer]-=c.closeH; assigned[closer].hours+=c.closeH;
        used.add(closer); paired=true; break;
      }
      if(!paired) continue;

      const preferCloseFirst = (regenTick%2===1);
      for(let tries=0; tries<4; tries++){
        const cnt = countDay(day);
        const pool = dipsOrdered
          .filter(n=>abs[n][day].type==="none" && !hasShift(dips.indexOf(n),day))
          .sort((a,b)=> (remain[b]-remain[a]) || (preferCloseFirst?-1:1)*b.localeCompare(a));

        if(preferCloseFirst && cnt.close<2 && pool.length){
          const n=pool.shift(), r=dips.indexOf(n);
          const opt=CLOSERS.find(x=>x.h<=remain[n]) || CLOSERS[CLOSERS.length-1];
          if(remain[n]>=opt.h){ writeShiftCell(r,day,'close',opt.h); remain[n]-=opt.h; assigned[n].hours+=opt.h; }
        }else if(cnt.open<2 && pool.length){
          const n=pool.shift(), r=dips.indexOf(n);
          const opt=OPENERS.find(x=>x.h<=remain[n]) || OPENERS[OPENERS.length-1];
          if(remain[n]>=opt.h){ writeShiftCell(r,day,'open',opt.h); remain[n]-=opt.h; assigned[n].hours+=opt.h; }
        }else if(!preferCloseFirst && cnt.close<2 && pool.length){
          const n=pool.shift(), r=dips.indexOf(n);
          const opt=CLOSERS.find(x=>x.h<=remain[n]) || CLOSERS[CLOSERS.length-1];
          if(remain[n]>=opt.h){ writeShiftCell(r,day,'close',opt.h); remain[n]-=opt.h; assigned[n].hours+=opt.h; }
        }else break;
      }
    }

    // upgrade per chiudere scarti (usando dataset)
    function upgrade(r,day){
      const info = cellInfo(r,day);
      if(!info) return false;
      const name=dips[r];
      if(info.type==='open'){
        if(info.hours===4 && remain[name]>0){ writeShiftCell(r,day,'open',5); remain[name]--; assigned[name].hours++; return true; }
        if(info.hours===5 && remain[name]>0){ writeShiftCell(r,day,'open',6); remain[name]--; assigned[name].hours++; return true; }
      }else{
        if(info.hours===5 && remain[name]>0){ writeShiftCell(r,day,'close',6); remain[name]--; assigned[name].hours++; return true; }
        if(info.hours===6 && remain[name]>0){ writeShiftCell(r,day,'close',7); remain[name]--; assigned[name].hours++; return true; }
      }
      return false;
    }
    for(let pass=0; pass<4; pass++){
      let moved=false;
      for(let r=0;r<dips.length;r++){
        while(remain[dips[r]]>0){
          let before=remain[dips[r]];
          for(const day of [6,5,0,1,2,3,4]){
            if(upgrade(r,day) && remain[dips[r]]===0) break;
          }
          if(remain[dips[r]]===before) break;
          moved=true;
        }
      }
      if(!moved) break;
    }

    // REC: se lavoro la DOMENICA, assegna su primo slot libero LUN‚ÜíVEN
    for(let r=0;r<dips.length;r++){
      const info = cellInfo(r,6);
      const workedSun = !!info; // se c'√® un turno domenica
      if(workedSun){
        for(const d of [0,1,2,3,4]){
          if(!cellInfo(r,d) && document.getElementById(`cell-${r}-${d}`).textContent.trim()==='riposo'){
            document.getElementById(`cell-${r}-${d}`).innerHTML = `<div class="rec" title="REC">REC</div>`;
            break;
          }
        }
      }
    }

    return {assigned, remain};
  }

  function render({assigned, remain}){
    const hBody=document.getElementById("hoursBody");
    let allExact=true;
    hBody.innerHTML = dips.map(name=>{
      const as=assigned[name].hours||0, ct=(CONTRACT_HOURS[name]??0);
      const delta=as-ct; if(delta!==0) allExact=false;
      return `<tr><td>${name}</td>
        <td style="text-align:center">${as}</td>
        <td style="text-align:center">${ct}</td>
        <td style="text-align:center" class="${delta===0?'delta-ok':'delta-bad'}">${delta===0?'0':(delta>0?`+${delta}`:delta)}</td>
      </tr>`;
    }).join("");

    const alertEl=document.getElementById("impossibleAlert");
    if(!allExact){
      alertEl.style.display='block';
      alertEl.innerHTML = `‚ö†Ô∏è Alcune ore non sono chiuse esattamente. Modifica assenze o clicca <b>Rigenera</b> per provare altre permutazioni.`;
    } else {
      alertEl.style.display='none'; alertEl.innerHTML='';
    }
  }

  // prima generazione
  regenerate();

})().catch(err=>{
  console.error(err);
  alert("Errore: "+err.message+"\nControlla che il foglio sia pubblicato e raggiungibile.");
});
</script>
</body>
</html>

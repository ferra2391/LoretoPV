<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<title>Planner Orari ‚Äì Settimana Successiva</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --border:#e6e8f0; --muted:#6b7280; --ink:#0f172a;
    --open:#dff7df; --close:#e5f0ff; --rest:#f3f4f6; --rec:#ffe7ec; --warn:#fff3cd;
    --danger:#dc2626; --ok:#16a34a;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:0 auto;padding:18px 20px}
  header .wrap{display:flex;flex-direction:column;align-items:center;text-align:center}
  h1{margin:0;font-size:22px}
  .badges{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px}
  .badge{display:inline-flex;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;font-size:12px}
  main.wrap{display:flex;flex-direction:column;gap:18px}
  .card{background:#fff;border:1px solid var(--border);border-radius:16px}
  .card-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .card-title{margin:0;font-size:16px}
  .controls{display:flex;align-items:center;gap:12px;font-size:14px;flex-wrap:wrap}
  .pill{display:inline-block;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer}

  .grid-wrap{border:1px solid var(--border);border-radius:12px;overflow:auto;background:#fff}
  table{width:100%;border-collapse:separate;border-spacing:0;min-width:980px;font-size:15px}
  thead th{position:sticky;top:0;background:#fff;z-index:2;border-bottom:1px solid var(--border);padding:10px 8px;white-space:nowrap}
  tbody td, tfoot td{padding:10px 8px;border-bottom:1px solid var(--border);vertical-align:top}
  th:first-child,td:first-child{position:sticky;left:0;background:#fff;z-index:3}
  th:first-child,td:first-child{text-align:left;width:220px}

  .open{background:var(--open)}
  .close{background:var(--close)}
  .rest{background:var(--rest);color:#374151}
  .rec{background:var(--rec)}
  .warn{background:var(--warn)}
  .mini{font-size:12px;color:#374151}
  .muted{color:var(--muted)}
  .delta-pos{color:var(--ok);font-weight:600}
  .delta-neg{color:var(--danger);font-weight:600}

  .tfoot-cell{background:#fafafa; position: sticky; bottom: 0; z-index: 1;}
  .tfoot-cell input{ transform: scale(1.1); }

  .hr-input{width:72px;padding:6px 8px;border:1px solid var(--border);border-radius:10px}
  .hr-form{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .abs-select{width:130px}
  .abs-hrs{width:70px}
  .alert{background:#fff7e6;border:1px solid #ffe5b4;border-radius:10px;padding:10px 12px;color:#8a6100}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>üóìÔ∏è Planner Orari ‚Äì Settimana Successiva</h1>
    <div class="badges">
      <div class="badge" id="badgeWeek">Settimana: ‚Äî</div>
      <div class="badge" id="badgeRange">Periodo: ‚Äî</div>
      <div class="badge" id="badgeUpdated">Aggiornato: ‚Äî</div>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- CONTRATTI -->
  <section class="card">
    <div class="card-header">
      <h2 class="card-title">Ore settimanali da contratto</h2>
      <div class="controls hr-form" id="hrForm"></div>
      <button id="applyHours" class="pill">Applica</button>
    </div>
    <div class="mini" style="padding:8px 16px 12px">
      Inserisci le ore contrattuali. Il planner cercher√† di assegnarle <b>tutte</b> rispettando i vincoli (1 turno/giorno, 4‚Äì6h, copertura 9‚Äì20).
    </div>
  </section>

  <!-- PLANNER -->
  <section class="card">
    <div class="card-header">
      <h2 class="card-title">Proposta turni (blocchi 4‚Äì6h, nessun turno centrale)</h2>
      <div class="controls">
        <button id="regen" class="pill">Rigenera</button>
        <span class="muted">Compresenza ON/OGGI in fondo a ogni colonna</span>
      </div>
    </div>

    <div class="grid-wrap">
      <table id="planTable">
        <thead>
          <tr>
            <th>Dipendente</th>
            <th id="d0">Luned√¨</th><th id="d1">Marted√¨</th><th id="d2">Mercoled√¨</th>
            <th id="d3">Gioved√¨</th><th id="d4">Venerd√¨</th><th id="d5">Sabato</th><th id="d6">Domenica</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
        <tfoot>
          <tr>
            <td class="tfoot-cell"><b>Compresenza</b> (per giorno)</td>
            <td class="tfoot-cell" data-day="0"><label><input type="checkbox" class="compToggle"> s√¨</label></td>
            <td class="tfoot-cell" data-day="1"><label><input type="checkbox" class="compToggle"> s√¨</label></td>
            <td class="tfoot-cell" data-day="2"><label><input type="checkbox" class="compToggle"> s√¨</label></td>
            <td class="tfoot-cell" data-day="3"><label><input type="checkbox" class="compToggle"> s√¨</label></td>
            <td class="tfoot-cell" data-day="4"><label><input type="checkbox" class="compToggle"> s√¨</label></td>
            <td class="tfoot-cell" data-day="5"><label><input type="checkbox" class="compToggle"> s√¨</label></td>
            <td class="tfoot-cell" data-day="6"><label><input type="checkbox" class="compToggle"> s√¨</label></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="mini" style="padding:10px 16px 14px">
      Coppie base che coprono 9‚Äì20: <b>9‚Äì14 + 14‚Äì20</b> (5h/6h) oppure <b>9‚Äì15 + 15‚Äì20</b> (6h/5h).  
      Compresenza ON ‚áí aggiunge <b>doppia apertura</b> (giorni pari) o <b>doppia chiusura</b> (giorni dispari). (Personalizzazione pi√π fine in step successivo).
    </div>

    <div id="impossibleAlert" class="alert" style="display:none; margin: 0 16px 16px;"></div>
  </section>

  <!-- ASSENZE -->
  <section class="card">
    <div class="card-header">
      <h2 class="card-title">Assenze programmate (Ferie / 104 / Malattia) ‚Äì settimana proposta</h2>
      <div class="controls"><button id="applyAbs" class="pill">Applica assenze</button></div>
    </div>
    <div class="grid-wrap">
      <table id="absTable">
        <thead>
          <tr>
            <th>Dipendente</th>
            <th>Luned√¨</th><th>Marted√¨</th><th>Mercoled√¨</th>
            <th>Gioved√¨</th><th>Venerd√¨</th><th>Sabato</th><th>Domenica</th>
          </tr>
        </thead>
        <tbody id="absBody"></tbody>
      </table>
    </div>
    <div class="mini" style="padding:10px 16px 14px">
      Ogni evento vale <b>ore di accredito</b> sul contratto (4/5/6) ma <b>non copre</b> il negozio: la copertura √® riassegnata ad altri.
    </div>
  </section>

  <!-- ORE -->
  <section class="card">
    <div class="card-header">
      <h2 class="card-title">Ore assegnate vs contratto (settimana proposta)</h2>
    </div>
    <div class="grid-wrap">
      <table id="hoursTable">
        <thead><tr><th>Dipendente</th><th>Ore assegnate</th><th>Contratto</th><th>Delta</th></tr></thead>
        <tbody id="hoursBody"></tbody>
      </table>
    </div>
  </section>
</main>

<script>
// ====== CONFIG ======
const PUBHTML = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTiGFO5sDWqthBzsCJ08wsG5bM4BjidbyZBwRXt32IuAkcr0BWhCmSTA-ZyayT07w/pubhtml?gid=876412715&single=true";

// iniziale (modificabile dall'UI)
let CONTRACT_HOURS = { Ilenia:30, Cinzia:35, Michela:32, Vivien:40 };

// blocchi ammessi (no centrali)
const OPENERS = [{h:6,label:"9‚Äì15"},{h:5,label:"9‚Äì14"},{h:4,label:"9‚Äì13"}];
const CLOSERS = [{h:6,label:"14‚Äì20"},{h:5,label:"15‚Äì20"},{h:4,label:"16‚Äì20"}];

// ====== date & holidays ======
function toYMD(d){ return d.toISOString().slice(0,10); }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function parseItaDate(s){ if(!s) return null; if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s); const m=s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/); if(!m) return new Date(s); return new Date(+m[3],+m[2]-1,+m[1]); }
function mondayOfNextWeek(base){ const b=new Date(base); const day=b.getDay()||7; const monday=addDays(b,1-day); return addDays(monday,7); }
function isoWeek(d){ const x=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate())); const wd=x.getUTCDay()||7; x.setUTCDate(x.getUTCDate()+4-wd); const y0=new Date(Date.UTC(x.getUTCFullYear(),0,1)); return Math.ceil((((x-y0)/86400000)+1)/7); }
function isoWeekYear(d){ const x=new Date(d.getTime()); x.setDate(x.getDate()+4-(x.getDay()||7)); return x.getFullYear(); }

function easterSunday(y){const a=y%19,b=Math.floor(y/100),c=y%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451);const month=Math.floor((h+l-7*m+114)/31), day=((h+l-7*m+114)%31)+1;return new Date(y,month-1,day);}
function italianHolidays(year){const set=new Set(); const add=(m,d)=>set.add(toYMD(new Date(year,m-1,d))); add(1,1);add(1,6);add(4,25);add(5,1);add(6,2);add(8,15);add(11,1);add(12,8);add(12,25);add(12,26); const e=easterSunday(year), p=addDays(e,1); set.add(toYMD(e)); set.add(toYMD(p)); return set;}
const HOLI=new Map();
function isHoliday(date){ const y=date.getFullYear(); if(!HOLI.has(y)) HOLI.set(y,italianHolidays(y)); return HOLI.get(y).has(toYMD(date)); }

// ====== CSV ======
function getPubInfo(pubhtml){ const idm=pubhtml.match(/\/d\/e\/([^/]+)\/pubhtml/); const gidm=pubhtml.match(/[?&]gid=(\d+)/); return {pubId:idm[1], gid: gidm?gidm[1]:"0"}; }
async function fetchCSV(url){ const r=await fetch(url); if(!r.ok) throw new Error(`Fetch failed ${r.status}`); const t=await r.text(); return Papa.parse(t,{header:true,skipEmptyLines:true}).data; }

// ====== MAIN ======
(async function main(){
  const now=new Date();
  document.getElementById("badgeUpdated").textContent = "Aggiornato: "+now.toLocaleDateString('it-IT')+" "+now.toLocaleTimeString('it-IT');

  const {pubId,gid}=getPubInfo(PUBHTML);
  let csv=`https://docs.google.com/spreadsheets/d/e/${pubId}/pub?gid=${gid}&single=true&output=csv`;
  let rows; try{ rows=await fetchCSV(csv);}catch{ csv=`https://docs.google.com/spreadsheets/d/e/${pubId}/gviz/tq?gid=${gid}&tqx=out:csv`; rows=await fetchCSV(csv); }

  const headers=rows.length?Object.keys(rows[0]):[];
  const colData=headers.find(k=>k.toLowerCase().includes("data"));
  const dipCols=headers.filter(k=>/ilenia|cinzia|michela|vivien/i.test(k));
  const dips=dipCols.slice();

  // range
  let maxDate=null;
  for(const r of rows){ const dt=parseItaDate(r[colData]); if(!dt||isNaN(+dt)) continue; if(!maxDate||dt>maxDate) maxDate=dt; }
  const start=mondayOfNextWeek(maxDate||new Date());
  const end=addDays(start,6);
  document.getElementById("badgeWeek").textContent=`Settimana: ${isoWeek(start)}/${isoWeekYear(start)}`;
  document.getElementById("badgeRange").textContent=`Periodo: ${start.toLocaleDateString('it-IT')} ‚Üí ${end.toLocaleDateString('it-IT')}`;
  const daysLabel=["Luned√¨","Marted√¨","Mercoled√¨","Gioved√¨","Venerd√¨","Sabato","Domenica"];
  for(let i=0;i<7;i++){ const d=addDays(start,i); document.getElementById("d"+i).textContent=`${daysLabel[i]} ${d.toLocaleDateString('it-IT')}`; }

  // pannello ore contratto
  const hrForm=document.getElementById("hrForm");
  hrForm.innerHTML = dips.map(n=>{
    const clean=n.replace(/\s+/g,' ').trim();
    const base = CONTRACT_HOURS[clean] ?? 30;
    return `<label>${clean} <input type="number" min="0" step="1" class="hr-input" data-name="${clean}" value="${base}"></label>`;
  }).join(" ‚Ä¢ ");
  document.getElementById("applyHours").addEventListener("click", ()=>{
    document.querySelectorAll('.hr-input').forEach(inp=>{
      const name=inp.dataset.name; CONTRACT_HOURS[name]=parseInt(inp.value,10)||0;
    }); regenerate();
  });

  // compresenza per giorno (default OFF)
  const comp = Array(7).fill(false);
  document.querySelectorAll('.compToggle').forEach((chk,idx)=>{
    chk.checked=false; chk.addEventListener('change',()=>{ comp[idx]=chk.checked; regenerate(); });
  });

  // tabella assenze (select evento + ore 4/5/6)
  const absBody=document.getElementById("absBody");
  function renderAbsTable(){
    absBody.innerHTML = dips.map((name,ri)=>`<tr>
      <td>${name}</td>
      ${Array.from({length:7},(_,di)=>`
        <td>
          <select class="abs-select" data-name="${name}" data-day="${di}">
            <option value="none">‚Äî</option>
            <option value="ferie">Ferie</option>
            <option value="104">104</option>
            <option value="malattia">Malattia</option>
          </select>
          <select class="abs-hrs" data-name="${name}" data-day="${di}">
            <option value="6">6h</option>
            <option value="5" selected>5h</option>
            <option value="4">4h</option>
          </select>
        </td>
      `).join("")}
    </tr>`).join("");
  }
  renderAbsTable();
  document.getElementById("applyAbs").addEventListener("click", regenerate);

  function readAbsences(){
    const abs = {}; dips.forEach(n=>abs[n]=Array(7).fill({type:"none", hrs:0}));
    document.querySelectorAll('.abs-select').forEach(sel=>{
      const name=sel.dataset.name, day=+sel.dataset.day;
      const hrsSel = document.querySelector(`.abs-hrs[data-name="${name}"][data-day="${day}"]`);
      const type = sel.value;
      const hrs = type==="none" ? 0 : parseInt(hrsSel.value,10)||0;
      if(!abs[name]) abs[name]=Array(7).fill({type:"none", hrs:0});
      abs[name][day] = {type, hrs};
    });
    return abs;
  }

  // ====== SCHEDULER ======
  function regenerate(){
    const abs = readAbsences();
    const plan = generate(comp.slice(), abs);
    render(plan);
  }

  function pickCandidate(candidates, dayIdx, usedToday, remain){
    // sceglie chi ha pi√π ore residue; evita chi ha gi√† un turno oggi
    const sorted = candidates
      .filter(n=>!usedToday.has(n) && remain[n]>0)
      .sort((a,b)=>remain[b]-remain[a]);
    return sorted[0] || null;
  }

  function generate(compByDay, abs){
    // ore restanti = contratto - accrediti da assenze
    const remain={}, assigned={};
    dips.forEach(n=>{ assigned[n]={hours:0}; remain[n]=(CONTRACT_HOURS[n]??0); });

    // accredita assenze
    for(const name of dips){
      for(let d=0; d<7; d++){
        const ev=abs[name][d];
        if(ev && ev.type!=="none"){
          remain[name] = Math.max(0, remain[name] - ev.hrs);
          assigned[name].hours += ev.hrs; // vale sul contratto
        }
      }
    }

    // griglia iniziale = riposo / eventi
    const grid=Array.from({length:dips.length}, ()=>Array(7).fill('<div class="rest">riposo</div>'));
    for(let r=0;r<dips.length;r++){
      const name=dips[r];
      for(let d=0; d<7; d++){
        const ev=abs[name][d];
        if(ev && ev.type!=="none"){
          const label = ev.type.toUpperCase()+" "+ev.hrs+"h";
          grid[r][d]=`<div class="rec" title="${label}">${label}</div>`;
        }
      }
    }

    // per ogni giorno: copertura 9‚Äì20
    for(let day=0; day<7; day++){
      // lista disponibili (non in assenza quel giorno)
      const available = dips.filter(n => {
        const ev = abs[n][day];
        return !(ev && ev.type!=="none");
      });

      const usedToday = new Set(); // chi ha gi√† un turno oggi

      // Scegli orientamento coppia base: alterna per semplicit√† (parit√† giorno)
      // pari: 9‚Äì15 + 15‚Äì20 (6/5), dispari: 9‚Äì14 + 14‚Äì20 (5/6)
      let baseOpen = (day%2===0) ? OPENERS[0] : OPENERS[1];
      let baseClose= (day%2===0) ? CLOSERS[1] : CLOSERS[0];

      // Assegna apertura
      let opener = pickCandidate(available, day, usedToday, remain);
      if(!opener){ continue; } // nessuno disponibile, si gestir√† manualmente
      let rOpen = dips.indexOf(opener);
      // se non ha ore sufficienti per l'apertura selezionata, prova apertura pi√π corta (6‚Üí5‚Üí4)
      let chosenOpen = baseOpen;
      if(remain[opener] < chosenOpen.h){ chosenOpen = OPENERS.find(o=>o.h<=remain[opener]) || chosenOpen; }
      grid[rOpen][day] = `<div class="open" title="${chosenOpen.label}">${chosenOpen.label}</div>`;
      remain[opener] -= chosenOpen.h; assigned[opener].hours += chosenOpen.h; usedToday.add(opener);

      // Assegna chiusura (evita opener)
      let closer = pickCandidate(available, day, usedToday, remain);
      if(!closer){
        // nessuno libero: prova a scambiare orientamento o segnala impossibile
        closer = dips.find(n=>!usedToday.has(n) && !(abs[n][day]&&abs[n][day].type!=="none"));
      }
      if(closer){
        let rClose = dips.indexOf(closer);
        let chosenClose = baseClose;
        if(remain[closer] < chosenClose.h){ chosenClose = CLOSERS.find(c=>c.h<=remain[closer]) || chosenClose; }
        grid[rClose][day] = `<div class="close" title="${chosenClose.label}">${chosenClose.label}</div>`;
        remain[closer] -= chosenClose.h; assigned[closer].hours += chosenClose.h; usedToday.add(closer);
      }

      // Compresenza se richiesta
      if(compByDay[day]){
        const compType = (day%2===0) ? "open" : "close"; // pari: doppia apertura, dispari: doppia chiusura
        let who = pickCandidate(available, day, usedToday, remain);
        if(who){
          const row = dips.indexOf(who);
          if(compType==="open"){
            // prova a mettere 4/5/6 a seconda delle ore residue
            const opt = OPENERS.slice().reverse().find(o=>o.h<=Math.max(6, remain[who])) || OPENERS[2];
            const best = [OPENERS[2], OPENERS[1], OPENERS[0]].find(o=>o.h<=remain[who]) || OPENERS[2];
            grid[row][day] = `<div class="open" title="${best.label}">${best.label}</div>`;
            remain[who] -= best.h; assigned[who].hours += best.h; usedToday.add(who);
          }else{
            const best = [CLOSERS[2], CLOSERS[1], CLOSERS[0]].find(c=>c.h<=remain[who]) || CLOSERS[2];
            grid[row][day] = `<div class="close" title="${best.label}">${best.label}</div>`;
            remain[who] -= best.h; assigned[who].hours += best.h; usedToday.add(who);
          }
        }
      }
    }

    // Domenica ‚Üí REC tra mar(1) e ven(4)
    for(let r=0;r<dips.length;r++){
      const name=dips[r];
      const workedSun = !grid[r][6].includes('riposo') && !grid[r][6].includes('FERIE') && !grid[r][6].includes('104') && !grid[r][6].includes('MALATTIA');
      if(workedSun){
        for(const d of [1,2,3,4]){
          if(grid[r][d].includes('riposo')){
            grid[r][d]=`<div class="rec" title="REC">REC</div>`;
            break;
          }
        }
      }
    }

    return {grid, assigned, remain};
  }

  function render(result){
    const {grid, assigned, remain}=result;

    // tabella turni
    const tbody=document.getElementById("tbody");
    tbody.innerHTML=dips.map((name,r)=>`<tr>
      <td>${name}</td>
      ${grid[r].map(cell=>`<td>${cell}</td>`).join("")}
    </tr>`).join("");

    // tabella ore
    const hBody=document.getElementById("hoursBody");
    let anyDelta=false;
    hBody.innerHTML = dips.map(name=>{
      const as=assigned[name].hours||0, ct=(CONTRACT_HOURS[name]??0);
      const delta = as-ct;
      if(delta!==0) anyDelta=true;
      const dCls = delta===0 ? '' : (delta>0?'delta-pos':'delta-neg');
      const dTxt = delta>0 ? `+${delta}` : `${delta}`;
      return `<tr>
        <td>${name}</td>
        <td style="text-align:center">${as}</td>
        <td style="text-align:center">${ct}</td>
        <td style="text-align:center" class="${dCls}">${delta===0?'0':dTxt}</td>
      </tr>`;
    }).join("");

    // avviso se non perfettamente chiuso
    const alertEl=document.getElementById("impossibleAlert");
    if(anyDelta){
      alertEl.style.display='block';
      alertEl.innerHTML = `‚ö†Ô∏è Con le impostazioni attuali (compresenze selezionate e max 1 turno/giorno) non √® possibile chiudere esattamente tutti i contratti. 
      Suggerimenti: <ul>
        <li>attiva compresenza in pi√π giorni e rigenera;</li>
        <li>aumenta le <b>durate</b> dei blocchi (vedi giorni pari/dispari: 6h/5h o 5h/6h);</li>
        <li>riduci le assenze accreditate o distribuiscile su altri giorni.</li>
      </ul>`;
    }else{
      alertEl.style.display='none';
      alertEl.innerHTML='';
    }
  }

  // prima generazione
  regenerate();

  document.getElementById("regen").addEventListener("click", regenerate);

})().catch(err=>{
  console.error(err);
  alert("Errore: "+err.message+"\nControlla che il foglio sia pubblicato e raggiungibile.");
});
</script>
</body>
</html>
